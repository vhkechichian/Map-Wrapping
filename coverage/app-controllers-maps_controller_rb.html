<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>
      app/controllers/maps_controller.rb - C0 code coverage information
    </title>
    <style type='text/css'>
      body { background-color: rgb(240, 240, 245); }
    </style>
    <style type='text/css'>
      span.cross-ref-title { font-size: 140%; } span.cross-ref a {
      text-decoration: none; } span.cross-ref { background-color:#f3f7fa;
      border: 1px dashed #333; margin: 1em; padding: 0.5em; overflow: hidden; }
      a.crossref-toggle { text-decoration: none; } span.marked0 {
      background-color: rgb(185, 210, 200); display: block; } span.marked1 {
      background-color: rgb(190, 215, 205); display: block; } span.inferred0 {
      background-color: rgb(175, 200, 200); display: block; } span.inferred1 {
      background-color: rgb(180, 205, 205); display: block; } span.uncovered0 {
      background-color: rgb(225, 110, 110); display: block; } span.uncovered1 {
      background-color: rgb(235, 120, 120); display: block; } span.overview {
      border-bottom: 8px solid black; } div.overview { border-bottom: 8px solid
      black; } body { font-family: verdana, arial, helvetica; } div.footer {
      font-size: 68%; margin-top: 1.5em; } h1, h2, h3, h4, h5, h6 {
      margin-bottom: 0.5em; } h5 { margin-top: 0.5em; } .hidden { display: none;
      } div.separator { height: 10px; } /* Commented out for better readability,
      esp. on IE */ /* table tr td, table tr th { font-size: 68%; } td.value
      table tr td { font-size: 11px; } */ table.percent_graph { height: 12px;
      border: #808080 1px solid; empty-cells: show; } table.percent_graph
      td.covered { height: 10px; background: #00f000; } table.percent_graph
      td.uncovered { height: 10px; background: #e00000; } table.percent_graph
      td.NA { height: 10px; background: #eaeaea; } table.report {
      border-collapse: collapse; width: 100%; } table.report td.heading {
      background: #dcecff; border: #d0d0d0 1px solid; font-weight: bold;
      text-align: center; } table.report td.heading:hover { background: #c0ffc0;
      } table.report td.text { border: #d0d0d0 1px solid; } table.report
      td.value, table.report td.lines_total, table.report td.lines_code {
      text-align: right; border: #d0d0d0 1px solid; } table.report tr.light {
      background-color: rgb(240, 240, 245); } table.report tr.dark {
      background-color: rgb(230, 230, 235); } 
    </style>
    <script type='text/javascript'>
       // <![CDATA[ function toggleCode( id ) { if ( document.getElementById )
      elem = document.getElementById( id ); else if ( document.all ) elem =
      eval( "document.all." + id ); else return false; elemStyle = elem.style;
      if ( elemStyle.display != "block" ) { elemStyle.display = "block" } else {
      elemStyle.display = "none" } return true; } // Make cross-references
      hidden by default document.writeln( "<style
      type=\"text/css\">span.cross-ref { display: none }</style>" ) // ]]> 
    </script>
    <style type='text/css'>
      span.run0 { background-color: rgb(178, 204, 255); display: block; }
      span.run1 { background-color: rgb(178, 206, 255); display: block; }
      span.run2 { background-color: rgb(178, 209, 255); display: block; }
      span.run3 { background-color: rgb(178, 211, 255); display: block; }
      span.run4 { background-color: rgb(178, 214, 255); display: block; }
      span.run5 { background-color: rgb(178, 218, 255); display: block; }
      span.run6 { background-color: rgb(178, 220, 255); display: block; }
      span.run7 { background-color: rgb(178, 223, 255); display: block; }
      span.run8 { background-color: rgb(178, 225, 255); display: block; }
      span.run9 { background-color: rgb(178, 228, 255); display: block; }
      span.run10 { background-color: rgb(178, 232, 255); display: block; }
      span.run11 { background-color: rgb(178, 234, 255); display: block; }
      span.run12 { background-color: rgb(178, 237, 255); display: block; }
      span.run13 { background-color: rgb(178, 239, 255); display: block; }
      span.run14 { background-color: rgb(178, 242, 255); display: block; }
      span.run15 { background-color: rgb(178, 246, 255); display: block; }
      span.run16 { background-color: rgb(178, 248, 255); display: block; }
      span.run17 { background-color: rgb(178, 251, 255); display: block; }
      span.run18 { background-color: rgb(178, 253, 255); display: block; }
      span.run19 { background-color: rgb(178, 255, 253); display: block; }
      span.run20 { background-color: rgb(178, 255, 249); display: block; }
      span.run21 { background-color: rgb(178, 255, 247); display: block; }
      span.run22 { background-color: rgb(178, 255, 244); display: block; }
      span.run23 { background-color: rgb(178, 255, 242); display: block; }
      span.run24 { background-color: rgb(178, 255, 239); display: block; }
      span.run25 { background-color: rgb(178, 255, 235); display: block; }
      span.run26 { background-color: rgb(178, 255, 233); display: block; }
      span.run27 { background-color: rgb(178, 255, 230); display: block; }
      span.run28 { background-color: rgb(178, 255, 228); display: block; }
      span.run29 { background-color: rgb(178, 255, 225); display: block; }
      span.run30 { background-color: rgb(178, 255, 221); display: block; }
      span.run31 { background-color: rgb(178, 255, 219); display: block; }
      span.run32 { background-color: rgb(178, 255, 216); display: block; }
      span.run33 { background-color: rgb(178, 255, 214); display: block; }
      span.run34 { background-color: rgb(178, 255, 211); display: block; }
      span.run35 { background-color: rgb(178, 255, 207); display: block; }
      span.run36 { background-color: rgb(178, 255, 205); display: block; }
      span.run37 { background-color: rgb(178, 255, 202); display: block; }
      span.run38 { background-color: rgb(178, 255, 200); display: block; }
      span.run39 { background-color: rgb(178, 255, 197); display: block; }
      span.run40 { background-color: rgb(178, 255, 193); display: block; }
      span.run41 { background-color: rgb(178, 255, 191); display: block; }
      span.run42 { background-color: rgb(178, 255, 188); display: block; }
      span.run43 { background-color: rgb(178, 255, 186); display: block; }
      span.run44 { background-color: rgb(178, 255, 183); display: block; }
      span.run45 { background-color: rgb(178, 255, 179); display: block; }
      span.run46 { background-color: rgb(179, 255, 178); display: block; }
      span.run47 { background-color: rgb(182, 255, 178); display: block; }
      span.run48 { background-color: rgb(184, 255, 178); display: block; }
      span.run49 { background-color: rgb(187, 255, 178); display: block; }
      span.run50 { background-color: rgb(191, 255, 178); display: block; }
      span.run51 { background-color: rgb(193, 255, 178); display: block; }
      span.run52 { background-color: rgb(196, 255, 178); display: block; }
      span.run53 { background-color: rgb(198, 255, 178); display: block; }
      span.run54 { background-color: rgb(201, 255, 178); display: block; }
      span.run55 { background-color: rgb(205, 255, 178); display: block; }
      span.run56 { background-color: rgb(207, 255, 178); display: block; }
      span.run57 { background-color: rgb(210, 255, 178); display: block; }
      span.run58 { background-color: rgb(212, 255, 178); display: block; }
      span.run59 { background-color: rgb(215, 255, 178); display: block; }
      span.run60 { background-color: rgb(219, 255, 178); display: block; }
      span.run61 { background-color: rgb(221, 255, 178); display: block; }
      span.run62 { background-color: rgb(224, 255, 178); display: block; }
      span.run63 { background-color: rgb(226, 255, 178); display: block; }
      span.run64 { background-color: rgb(229, 255, 178); display: block; }
      span.run65 { background-color: rgb(233, 255, 178); display: block; }
      span.run66 { background-color: rgb(235, 255, 178); display: block; }
      span.run67 { background-color: rgb(238, 255, 178); display: block; }
      span.run68 { background-color: rgb(240, 255, 178); display: block; }
      span.run69 { background-color: rgb(243, 255, 178); display: block; }
      span.run70 { background-color: rgb(247, 255, 178); display: block; }
      span.run71 { background-color: rgb(249, 255, 178); display: block; }
      span.run72 { background-color: rgb(252, 255, 178); display: block; }
      span.run73 { background-color: rgb(255, 255, 178); display: block; }
      span.run74 { background-color: rgb(255, 252, 178); display: block; }
      span.run75 { background-color: rgb(255, 248, 178); display: block; }
      span.run76 { background-color: rgb(255, 246, 178); display: block; }
      span.run77 { background-color: rgb(255, 243, 178); display: block; }
      span.run78 { background-color: rgb(255, 240, 178); display: block; }
      span.run79 { background-color: rgb(255, 238, 178); display: block; }
      span.run80 { background-color: rgb(255, 234, 178); display: block; }
      span.run81 { background-color: rgb(255, 232, 178); display: block; }
      span.run82 { background-color: rgb(255, 229, 178); display: block; }
      span.run83 { background-color: rgb(255, 226, 178); display: block; }
      span.run84 { background-color: rgb(255, 224, 178); display: block; }
      span.run85 { background-color: rgb(255, 220, 178); display: block; }
      span.run86 { background-color: rgb(255, 218, 178); display: block; }
      span.run87 { background-color: rgb(255, 215, 178); display: block; }
      span.run88 { background-color: rgb(255, 212, 178); display: block; }
      span.run89 { background-color: rgb(255, 210, 178); display: block; }
      span.run90 { background-color: rgb(255, 206, 178); display: block; }
      span.run91 { background-color: rgb(255, 204, 178); display: block; }
      span.run92 { background-color: rgb(255, 201, 178); display: block; }
      span.run93 { background-color: rgb(255, 198, 178); display: block; }
      span.run94 { background-color: rgb(255, 196, 178); display: block; }
      span.run95 { background-color: rgb(255, 192, 178); display: block; }
      span.run96 { background-color: rgb(255, 189, 178); display: block; }
      span.run97 { background-color: rgb(255, 187, 178); display: block; }
      span.run98 { background-color: rgb(255, 184, 178); display: block; }
      span.run99 { background-color: rgb(255, 182, 178); display: block; }
      span.run100 { background-color: rgb(255, 178, 178); display: block; } 
    </style>
  </head>
  <body>
    <h3>
      C0 code coverage information
    </h3>
    <p>
      Generated on Mon Mar 02 12:22:12 +0000 2009 with 
      <a href='http://eigenclass.org/hiki/rcov'>
        rcov 0.8.1.2
      </a>
    </p>
    <hr />
    <pre><span class='marked0'>Code reported as executed by Ruby looks like
    this... </span><span class='marked1'>and this: this line is also marked as
    covered. </span><span class='inferred0'>Lines considered as run by rcov, but
    not reported by Ruby, look like this, </span><span class='inferred1'>and
    this: these lines were inferred by rcov (using simple heuristics).
    </span><span class='uncovered0'>Finally, here&apos;s a line marked as not
    executed. </span></pre> 
    <table class='report'> <thead> <tr> <td class='heading'> Name </td> <td
    class='heading'> Total lines </td> <td class='heading'> Lines of code </td>
    <td class='heading'> Total coverage </td> <td class='heading'> Code coverage
    </td> </tr> </thead> <tbody> <tr class='light'> <td> <a
    href='app-controllers-maps_controller_rb.html'>
    app/controllers/maps_controller.rb </a> </td> <td class='lines_total'> <tt>
    522 </tt> </td> <td class='lines_code'> <tt> 397 </tt> </td> <td> <table
    cellspacing='0' align='right' cellpadding='0'> <tr> <td> <tt
    class='coverage_total'> 29.9% </tt> &nbsp; </td> <td> <table
    class='percent_graph' cellspacing='0' width='100' cellpadding='0'> <tr> <td
    class='covered' width='30' /> <td class='uncovered' width='70' /> </tr>
    </table> </td> </tr> </table> </td> <td> <table cellspacing='0'
    align='right' cellpadding='0'> <tr> <td> <tt class='coverage_code'> 22.9%
    </tt> &nbsp; </td> <td> <table class='percent_graph' cellspacing='0'
    width='100' cellpadding='0'> <tr> <td class='covered' width='23' /> <td
    class='uncovered' width='77' /> </tr> </table> </td> </tr> </table> </td>
    </tr> </tbody> </table><pre><span class="marked1"><a name="line1"></a> 1
    class MapsController &lt; ApplicationController </span><span
    class="inferred0"><a name="line2"></a> 2 # GET /maps </span><span
    class="inferred1"><a name="line3"></a> 3 # GET /maps.xml </span><span
    class="marked0"><a name="line4"></a> 4 layout 'mapdetail', :except =&gt;
    [:index, :new, :tag] </span><span class="marked1"><a name="line5"></a> 5
    before_filter :login_required, :only =&gt; [:destroy] </span><span
    class="inferred0"><a name="line6"></a> 6 #before_filter :login_required,
    :only =&gt; [:warp, :rectify, :clip, :align, </span><span
    class="inferred1"><a name="line7"></a> 7 #:warp_align, :mask_map,
    :delete_mask, :save_mask, :save_mask_and_warp ] </span><span
    class="marked0"><a name="line8"></a> 8 before_filter
    :check_administrator_role, :only =&gt; [:publish, :destroy] </span><span
    class="marked1"><a name="line9"></a> 9 before_filter :find_map_if_available,
    </span><span class="inferred0"><a name="line10"></a> 10 :except =&gt;
    [:show, :index, :wms, :mapserver_wms, :warp_aligned, :status, :new, :create,
    :update, :edit, :tag] </span><span class="inferred1"><a name="line11"></a>
    11 </span><span class="marked0"><a name="line12"></a> 12 before_filter
    :check_link_back, :only =&gt; [:show, :warp, :clip, :align, :warped,
    :activity] </span><span class="marked1"><a name="line13"></a> 13
    before_filter :check_if_map_is_editable, :only =&gt; [:edit, :update,
    :destroy] </span><span class="marked0"><a name="line14"></a> 14 helper :sort
    </span><span class="marked1"><a name="line15"></a> 15 include SortHelper
    </span><span class="inferred0"><a name="line16"></a> 16 </span><span
    class="marked1"><a name="line17"></a> 17 def index </span><span
    class="inferred0"><a name="line18"></a> 18 </span><span class="marked1"><a
    name="line19"></a> 19 sort_init('updated_at', {:default_order =&gt;
    &quot;desc&quot;}) </span><span class="marked0"><a name="line20"></a> 20
    sort_update </span><span class="marked1"><a name="line21"></a> 21
    @show_warped = params[:show_warped] </span><span class="marked0"><a
    name="line22"></a> 22 request.query_string.length &gt; 0 ? qstring =
    &quot;?&quot; + request.query_string : qstring = &quot;&quot; </span><span
    class="inferred1"><a name="line23"></a> 23 </span><span class="marked0"><a
    name="line24"></a> 24 set_session_link_back url_for(:controller=&gt; 'maps',
    :action =&gt; 'index',:skip_relative_url_root =&gt; false, :only_path =&gt;
    false )+ qstring </span><span class="inferred1"><a name="line25"></a> 25
    </span><span class="marked0"><a name="line26"></a> 26 @query =
    params[:query] </span><span class="inferred1"><a name="line27"></a> 27
    </span><span class="marked0"><a name="line28"></a> 28 @field = %w(tags title
    description status publisher authors).detect{|f| f == (params[:field])}
    </span><span class="inferred1"><a name="line29"></a> 29 </span><span
    class="marked0"><a name="line30"></a> 30 unless @field == &quot;tags&quot;
    </span><span class="inferred1"><a name="line31"></a> 31 </span><span
    class="marked0"><a name="line32"></a> 32 @field = &quot;title&quot; if
    @field.nil? </span><span class="inferred1"><a name="line33"></a> 33
    </span><span class="marked0"><a name="line34"></a> 34 if @query &amp;&amp;
    @query.strip.length &gt; 0 &amp;&amp; @field </span><span
    class="inferred1"><a name="line35"></a> 35 if @show_warped == &quot;1&quot;
    </span><span class="uncovered0"><a name="line36"></a> 36 conditions =
    [&quot;upper(#{@field} ) LIKE ? AND status = 4 &quot;, '%'+@query.upcase+'%'
    ] </span><span class="uncovered1"><a name="line37"></a> 37 else </span><span
    class="uncovered0"><a name="line38"></a> 38 conditions =
    [&quot;upper(#{@field} ) LIKE ? &quot;, '%'+@query.upcase+'%'] </span><span
    class="uncovered1"><a name="line39"></a> 39 end </span><span
    class="inferred0"><a name="line40"></a> 40 else </span><span
    class="marked1"><a name="line41"></a> 41 if @show_warped == &quot;1&quot;
    </span><span class="uncovered0"><a name="line42"></a> 42 conditions =
    [&quot;status = 4 &quot;] </span><span class="inferred1"><a
    name="line43"></a> 43 else </span><span class="marked0"><a
    name="line44"></a> 44 conditions = nil </span><span class="inferred1"><a
    name="line45"></a> 45 end </span><span class="inferred0"><a
    name="line46"></a> 46 end </span><span class="marked1"><a name="line47"></a>
    47 @maps = Map.public.paginate(:page =&gt; params[:page], </span><span
    class="inferred0"><a name="line48"></a> 48 :per_page =&gt; 10, </span><span
    class="marked1"><a name="line49"></a> 49 :order =&gt; sort_clause,
    </span><span class="inferred0"><a name="line50"></a> 50 :conditions =&gt;
    conditions, </span><span class="inferred1"><a name="line51"></a> 51 :include
    =&gt;[:gcps,:users]) </span><span class="marked0"><a name="line52"></a> 52
    @html_title = &quot;Maps&quot; </span><span class="marked1"><a
    name="line53"></a> 53 respond_to do |format| </span><span class="marked0"><a
    name="line54"></a> 54 format.html{ render :layout =&gt;'application' } #
    index.html.erb </span><span class="marked1"><a name="line55"></a> 55
    format.xml { render :xml =&gt; @maps } </span><span class="inferred0"><a
    name="line56"></a> 56 end </span><span class="uncovered1"><a
    name="line57"></a> 57 else </span><span class="uncovered0"><a
    name="line58"></a> 58 redirect_to :action =&gt; 'tag', :id =&gt; @query
    </span><span class="uncovered1"><a name="line59"></a> 59 end </span><span
    class="uncovered0"><a name="line60"></a> 60 end </span><span
    class="inferred1"><a name="line61"></a> 61 </span><span class="marked0"><a
    name="line62"></a> 62 def tag </span><span class="marked1"><a
    name="line63"></a> 63 sort_init('updated_at', {:default_order =&gt;
    &quot;desc&quot;}) </span><span class="marked0"><a name="line64"></a> 64
    sort_update </span><span class="marked1"><a name="line65"></a> 65 @tags =
    params[:id] || @query </span><span class="inferred0"><a name="line66"></a>
    66 </span><span class="marked1"><a name="line67"></a> 67 @maps =
    Map.paged_find_tagged_with( </span><span class="inferred0"><a
    name="line68"></a> 68 @tags, </span><span class="marked1"><a
    name="line69"></a> 69 :page =&gt; params[:page], </span><span
    class="inferred0"><a name="line70"></a> 70 :per_page =&gt; 20, </span><span
    class="marked1"><a name="line71"></a> 71 :order =&gt; sort_clause)
    </span><span class="marked0"><a name="line72"></a> 72 respond_to do |format|
    </span><span class="marked1"><a name="line73"></a> 73 format.html{ render
    :layout =&gt;'application' } # index.html.erb </span><span
    class="marked0"><a name="line74"></a> 74 format.xml { render :xml =&gt;
    @maps } </span><span class="marked1"><a name="line75"></a> 75 format.rss {
    render :layout =&gt; false } </span><span class="inferred0"><a
    name="line76"></a> 76 end </span><span class="inferred1"><a
    name="line77"></a> 77 end </span><span class="inferred0"><a
    name="line78"></a> 78 </span><span class="marked1"><a name="line79"></a> 79
    def export </span><span class="uncovered0"><a name="line80"></a> 80
    @current_tab = :export </span><span class="uncovered1"><a name="line81"></a>
    81 @html_title = &quot;Export Map&quot; </span><span class="uncovered0"><a
    name="line82"></a> 82 respond_to do |format| </span><span
    class="uncovered1"><a name="line83"></a> 83 format.html #export.html.erb
    </span><span class="uncovered0"><a name="line84"></a> 84 end </span><span
    class="uncovered1"><a name="line85"></a> 85 end </span><span
    class="inferred0"><a name="line86"></a> 86 </span><span class="marked1"><a
    name="line87"></a> 87 def new </span><span class="uncovered0"><a
    name="line88"></a> 88 @map = Map.new </span><span class="uncovered1"><a
    name="line89"></a> 89 @html_title = &quot;New Map&quot; </span><span
    class="uncovered0"><a name="line90"></a> 90 @max_size =
    Map.max_attachment_size </span><span class="uncovered1"><a
    name="line91"></a> 91 if Map.max_dimension </span><span
    class="uncovered0"><a name="line92"></a> 92 @upload_file_message = &quot; It
    may resize the image if it's too large
    (#{Map.max_dimension}x#{Map.max_dimension}) &quot; </span><span
    class="uncovered1"><a name="line93"></a> 93 else </span><span
    class="uncovered0"><a name="line94"></a> 94 @upload_file_message =
    &quot;&quot; </span><span class="uncovered1"><a name="line95"></a> 95 end
    </span><span class="uncovered0"><a name="line96"></a> 96 </span><span
    class="uncovered1"><a name="line97"></a> 97 respond_to do |format|
    </span><span class="uncovered0"><a name="line98"></a> 98 format.html{ render
    :layout =&gt;'application' } # new.html.erb </span><span
    class="uncovered1"><a name="line99"></a> 99 format.xml { render :xml =&gt;
    @map } </span><span class="uncovered0"><a name="line100"></a>100 end
    </span><span class="uncovered1"><a name="line101"></a>101 end </span><span
    class="inferred0"><a name="line102"></a>102 </span><span class="marked1"><a
    name="line103"></a>103 def create </span><span class="marked0"><a
    name="line104"></a>104 @map = Map.new(params[:map]) </span><span
    class="inferred1"><a name="line105"></a>105 </span><span class="marked0"><a
    name="line106"></a>106 if logged_in? </span><span class="uncovered1"><a
    name="line107"></a>107 @map.owner = current_user </span><span
    class="uncovered0"><a name="line108"></a>108 @map.users &lt;&lt;
    current_user </span><span class="uncovered1"><a name="line109"></a>109 end
    </span><span class="inferred0"><a name="line110"></a>110 </span><span
    class="marked1"><a name="line111"></a>111 respond_to do |format|
    </span><span class="marked0"><a name="line112"></a>112 if @map.save
    </span><span class="marked1"><a name="line113"></a>113 flash[:notice] = 'Map
    was successfully created.' </span><span class="marked0"><a
    name="line114"></a>114 format.html { redirect_to(@map) } </span><span
    class="marked1"><a name="line115"></a>115 format.xml { render :xml =&gt;
    @map, :status =&gt; :created, :location =&gt; @map } </span><span
    class="uncovered0"><a name="line116"></a>116 else </span><span
    class="uncovered1"><a name="line117"></a>117 format.html { render :action
    =&gt; &quot;new&quot;, :layout =&gt;'application' } </span><span
    class="uncovered0"><a name="line118"></a>118 format.xml { render :xml =&gt;
    @map.errors, :status =&gt; :unprocessable_entity } </span><span
    class="uncovered1"><a name="line119"></a>119 end </span><span
    class="uncovered0"><a name="line120"></a>120 end </span><span
    class="uncovered1"><a name="line121"></a>121 end </span><span
    class="inferred0"><a name="line122"></a>122 </span><span
    class="inferred1"><a name="line123"></a>123 </span><span class="marked0"><a
    name="line124"></a>124 def edit </span><span class="uncovered1"><a
    name="line125"></a>125 @current_tab = :edit </span><span
    class="uncovered0"><a name="line126"></a>126 @html_title = &quot;Edit
    metadata&quot; </span><span class="uncovered1"><a name="line127"></a>127
    @html_title = &quot;Editing Map - &quot; + @map.title </span><span
    class="uncovered0"><a name="line128"></a>128 respond_to do |format|
    </span><span class="uncovered1"><a name="line129"></a>129 format.html #{
    render :layout =&gt;'application' } # new.html.erb </span><span
    class="uncovered0"><a name="line130"></a>130 format.xml { render :xml =&gt;
    @map } </span><span class="uncovered1"><a name="line131"></a>131 end
    </span><span class="uncovered0"><a name="line132"></a>132 end </span><span
    class="inferred1"><a name="line133"></a>133 </span><span class="marked0"><a
    name="line134"></a>134 def update </span><span class="uncovered1"><a
    name="line135"></a>135 #@map = Map.find(params[:id]) </span><span
    class="uncovered0"><a name="line136"></a>136 respond_to do |format|
    </span><span class="uncovered1"><a name="line137"></a>137 if
    @map.update_attributes(params[:map]) </span><span class="uncovered0"><a
    name="line138"></a>138 flash[:notice] = 'Map was successfully updated.'
    </span><span class="uncovered1"><a name="line139"></a>139 format.html {
    redirect_to(@map) } </span><span class="uncovered0"><a
    name="line140"></a>140 format.xml { head :ok } </span><span
    class="uncovered1"><a name="line141"></a>141 else </span><span
    class="uncovered0"><a name="line142"></a>142 format.html { render :action
    =&gt; &quot;edit&quot; } </span><span class="uncovered1"><a
    name="line143"></a>143 format.xml { render :xml =&gt; @map.errors, :status
    =&gt; :unprocessable_entity } </span><span class="uncovered0"><a
    name="line144"></a>144 end </span><span class="uncovered1"><a
    name="line145"></a>145 end </span><span class="uncovered0"><a
    name="line146"></a>146 end </span><span class="inferred1"><a
    name="line147"></a>147 </span><span class="inferred0"><a
    name="line148"></a>148 #only admins can do this </span><span
    class="marked1"><a name="line149"></a>149 def destroy </span><span
    class="uncovered0"><a name="line150"></a>150 map = Map.find(params[:id])
    </span><span class="uncovered1"><a name="line151"></a>151 if map.destroy
    </span><span class="uncovered0"><a name="line152"></a>152 flash[:notice] =
    &quot;map deleted&quot; </span><span class="uncovered1"><a
    name="line153"></a>153 else </span><span class="uncovered0"><a
    name="line154"></a>154 flash[:notice] = &quot;map wasnt deleted&quot;
    </span><span class="uncovered1"><a name="line155"></a>155 end </span><span
    class="uncovered0"><a name="line156"></a>156 respond_to do |format|
    </span><span class="uncovered1"><a name="line157"></a>157 format.html {
    redirect_to(maps_url) } </span><span class="uncovered0"><a
    name="line158"></a>158 format.xml { head :ok } </span><span
    class="uncovered1"><a name="line159"></a>159 end </span><span
    class="uncovered0"><a name="line160"></a>160 end </span><span
    class="inferred1"><a name="line161"></a>161 </span><span
    class="inferred0"><a name="line162"></a>162 </span><span class="marked1"><a
    name="line163"></a>163 def status </span><span class="uncovered0"><a
    name="line164"></a>164 map = Map.find(params[:id]) </span><span
    class="uncovered1"><a name="line165"></a>165 if map.status.nil? </span><span
    class="uncovered0"><a name="line166"></a>166 sta = &quot;loading&quot;
    </span><span class="uncovered1"><a name="line167"></a>167 else </span><span
    class="uncovered0"><a name="line168"></a>168 sta = map.status.to_s
    </span><span class="uncovered1"><a name="line169"></a>169 end </span><span
    class="uncovered0"><a name="line170"></a>170 render :text =&gt; sta
    </span><span class="uncovered1"><a name="line171"></a>171 end </span><span
    class="inferred0"><a name="line172"></a>172 </span><span class="marked1"><a
    name="line173"></a>173 def show </span><span class="uncovered0"><a
    name="line174"></a>174 </span><span class="uncovered1"><a
    name="line175"></a>175 @current_tab = :show </span><span
    class="uncovered0"><a name="line176"></a>176 @map = Map.find(params[:id])
    </span><span class="uncovered1"><a name="line177"></a>177 @html_title =
    &quot;Map - &quot; + @map.title </span><span class="uncovered0"><a
    name="line178"></a>178 if @map.status.nil? || @map.status == :unloaded
    </span><span class="uncovered1"><a name="line179"></a>179 @mapstatus =
    &quot;unloaded&quot; </span><span class="uncovered0"><a
    name="line180"></a>180 else </span><span class="uncovered1"><a
    name="line181"></a>181 @mapstatus = @map.status.to_s </span><span
    class="uncovered0"><a name="line182"></a>182 end </span><span
    class="uncovered1"><a name="line183"></a>183 </span><span
    class="uncovered0"><a name="line184"></a>184 #TODO temorary fix to stop non
    logged in users spamming </span><span class="uncovered1"><a
    name="line185"></a>185 # if !logged_in? </span><span class="uncovered0"><a
    name="line186"></a>186 # </span><span class="uncovered1"><a
    name="line187"></a>187 # flash[:notice] = &quot;You may need to log in to
    start editing the map&quot; </span><span class="uncovered0"><a
    name="line188"></a>188 # render :action =&gt; &quot;preview&quot;
    </span><span class="uncovered1"><a name="line189"></a>189 # return #stop
    doing anything more </span><span class="uncovered0"><a
    name="line190"></a>190 # end </span><span class="uncovered1"><a
    name="line191"></a>191 #note, trying to view an image that hasnt been
    requested, will cause it to be requested </span><span class="uncovered0"><a
    name="line192"></a>192 if @map.status.nil? or @map.status == :unloaded
    </span><span class="uncovered1"><a name="line193"></a>193 @disabled_tabs =
    [:warp, :clip, :align, :warped, :activity] </span><span
    class="uncovered0"><a name="line194"></a>194 @title = &quot;Viewing
    unrectified map.&quot; </span><span class="uncovered1"><a
    name="line195"></a>195 render :action =&gt; &quot;preview&quot; </span><span
    class="uncovered0"><a name="line196"></a>196 return </span><span
    class="uncovered1"><a name="line197"></a>197 </span><span
    class="uncovered0"><a name="line198"></a>198 end </span><span
    class="uncovered1"><a name="line199"></a>199 </span><span
    class="uncovered0"><a name="line200"></a>200 @title = &quot;Viewing original
    map. &quot; </span><span class="uncovered1"><a name="line201"></a>201 if
    @map.status != :warped </span><span class="uncovered0"><a
    name="line202"></a>202 @title += &quot;This map has not been rectified
    yet.&quot; </span><span class="uncovered1"><a name="line203"></a>203 end
    </span><span class="uncovered0"><a name="line204"></a>204 </span><span
    class="uncovered1"><a name="line205"></a>205 respond_to do |format|
    </span><span class="uncovered0"><a name="line206"></a>206 format.html #
    show.html.erb </span><span class="uncovered1"><a name="line207"></a>207
    format.kml { render :action =&gt; 'show', :layout =&gt; false } </span><span
    class="uncovered0"><a name="line208"></a>208 #format.xml { render :xml =&gt;
    @map } </span><span class="uncovered1"><a name="line209"></a>209 end
    </span><span class="uncovered0"><a name="line210"></a>210 </span><span
    class="uncovered1"><a name="line211"></a>211 # end </span><span
    class="uncovered0"><a name="line212"></a>212 end </span><span
    class="inferred1"><a name="line213"></a>213 </span><span class="marked0"><a
    name="line214"></a>214 def clip </span><span class="uncovered1"><a
    name="line215"></a>215 @html_title = &quot;Crop Map - &quot; + @map.title
    </span><span class="uncovered0"><a name="line216"></a>216 @current_tab =
    :clip </span><span class="uncovered1"><a name="line217"></a>217 # @map =
    Map.find(params[:id]) </span><span class="uncovered0"><a
    name="line218"></a>218 @gml_exists = &quot;false&quot; </span><span
    class="uncovered1"><a name="line219"></a>219 if
    File.exists?(@map.masking_file_gml+&quot;.ol&quot;) </span><span
    class="uncovered0"><a name="line220"></a>220 @gml_exists = &quot;true&quot;
    </span><span class="uncovered1"><a name="line221"></a>221 end </span><span
    class="uncovered0"><a name="line222"></a>222 end </span><span
    class="inferred1"><a name="line223"></a>223 </span><span
    class="inferred0"><a name="line224"></a>224 #should check for admin only
    </span><span class="marked1"><a name="line225"></a>225 def publish
    </span><span class="uncovered0"><a name="line226"></a>226 # @map =
    Map.find(params[:id]) </span><span class="uncovered1"><a
    name="line227"></a>227 @map.publish </span><span class="uncovered0"><a
    name="line228"></a>228 render :text =&gt; &quot;Map will be published. (this
    functionality doesn't do anything at the moment)&quot; </span><span
    class="uncovered1"><a name="line229"></a>229 end </span><span
    class="inferred0"><a name="line230"></a>230 </span><span class="marked1"><a
    name="line231"></a>231 def save_mask </span><span class="uncovered0"><a
    name="line232"></a>232 message = @map.save_mask(params[:output])
    </span><span class="uncovered1"><a name="line233"></a>233 render :text =&gt;
    message </span><span class="uncovered0"><a name="line234"></a>234 end
    </span><span class="inferred1"><a name="line235"></a>235 </span><span
    class="marked0"><a name="line236"></a>236 def delete_mask </span><span
    class="uncovered1"><a name="line237"></a>237 message = @map.delete_mask
    </span><span class="uncovered0"><a name="line238"></a>238 render :text =&gt;
    message </span><span class="uncovered1"><a name="line239"></a>239 end
    </span><span class="inferred0"><a name="line240"></a>240 </span><span
    class="marked1"><a name="line241"></a>241 def mask_map </span><span
    class="uncovered0"><a name="line242"></a>242 message = @map.mask!
    </span><span class="uncovered1"><a name="line243"></a>243 render :text =&gt;
    message </span><span class="uncovered0"><a name="line244"></a>244 end
    </span><span class="inferred1"><a name="line245"></a>245 </span><span
    class="inferred0"><a name="line246"></a>246 </span><span
    class="inferred1"><a name="line247"></a>247 </span><span class="marked0"><a
    name="line248"></a>248 def warped </span><span class="uncovered1"><a
    name="line249"></a>249 @html_title = &quot;Showing rectified map - &quot; +
    @map.title </span><span class="uncovered0"><a name="line250"></a>250
    @current_tab = :warped </span><span class="uncovered1"><a
    name="line251"></a>251 if @map.status == :warped and @map.gcps.size &gt; 2
    </span><span class="uncovered0"><a name="line252"></a>252 @title =
    &quot;Viewing warped map&quot; </span><span class="uncovered1"><a
    name="line253"></a>253 width = @map.width </span><span class="uncovered0"><a
    name="line254"></a>254 height = @map.height </span><span
    class="uncovered1"><a name="line255"></a>255 </span><span
    class="uncovered0"><a name="line256"></a>256 respond_to do |format|
    </span><span class="uncovered1"><a name="line257"></a>257 format.html #
    show.html.erb </span><span class="uncovered0"><a name="line258"></a>258
    #format.xml { render :xml =&gt; @map } </span><span class="uncovered1"><a
    name="line259"></a>259 end </span><span class="uncovered0"><a
    name="line260"></a>260 else </span><span class="uncovered1"><a
    name="line261"></a>261 flash[:notice] = &quot;Whoops, you have to rectify a
    map before you can view it&quot; </span><span class="uncovered0"><a
    name="line262"></a>262 redirect_to :action =&gt; &quot;show&quot;
    </span><span class="uncovered1"><a name="line263"></a>263 end </span><span
    class="uncovered0"><a name="line264"></a>264 end </span><span
    class="inferred1"><a name="line265"></a>265 </span><span class="marked0"><a
    name="line266"></a>266 def warp_aligned </span><span class="uncovered1"><a
    name="line267"></a>267 destmap = Map.find(params[:destmap]) </span><span
    class="uncovered0"><a name="line268"></a>268 params[:id] = params[:destmap]
    </span><span class="uncovered1"><a name="line269"></a>269 align =
    params[:align].downcase </span><span class="uncovered0"><a
    name="line270"></a>270 </span><span class="uncovered1"><a
    name="line271"></a>271 append = params[:append] </span><span
    class="uncovered0"><a name="line272"></a>272 if params[:align_type] ==
    &quot;original&quot; </span><span class="uncovered1"><a
    name="line273"></a>273 result = destmap.align_with_original(params[:srcmap],
    align, append ) </span><span class="uncovered0"><a name="line274"></a>274
    else </span><span class="uncovered1"><a name="line275"></a>275 result =
    destmap.align_with_warped(params[:srcmap], align, append ) </span><span
    class="uncovered0"><a name="line276"></a>276 end </span><span
    class="uncovered1"><a name="line277"></a>277 flash[:notice] = &quot;map
    aligned&quot; </span><span class="uncovered0"><a name="line278"></a>278
    redirect_to :action =&gt; &quot;warp&quot;, :id =&gt; destmap.id
    </span><span class="uncovered1"><a name="line279"></a>279 end </span><span
    class="inferred0"><a name="line280"></a>280 </span><span class="marked1"><a
    name="line281"></a>281 def align </span><span class="uncovered0"><a
    name="line282"></a>282 @current_tab = :align </span><span
    class="uncovered1"><a name="line283"></a>283 @html_title = &quot;Align Map -
    &quot; + @map.title </span><span class="uncovered0"><a
    name="line284"></a>284 width = @map.width </span><span class="uncovered1"><a
    name="line285"></a>285 height = @map.height </span><span
    class="uncovered0"><a name="line286"></a>286 end </span><span
    class="inferred1"><a name="line287"></a>287 </span><span class="marked0"><a
    name="line288"></a>288 def warp </span><span class="uncovered1"><a
    name="line289"></a>289 @html_title = &quot;Rectify Map - &quot; + @map.title
    </span><span class="uncovered0"><a name="line290"></a>290 @current_tab =
    :warp </span><span class="uncovered1"><a name="line291"></a>291 </span><span
    class="uncovered0"><a name="line292"></a>292 </span><span
    class="uncovered1"><a name="line293"></a>293 @gcps = @map.gcps_with_error
    </span><span class="uncovered0"><a name="line294"></a>294 </span><span
    class="uncovered1"><a name="line295"></a>295 width = @map.width </span><span
    class="uncovered0"><a name="line296"></a>296 height = @map.height
    </span><span class="uncovered1"><a name="line297"></a>297 width_ratio =
    width / 180 </span><span class="uncovered0"><a name="line298"></a>298
    height_ratio = height / 90 </span><span class="uncovered1"><a
    name="line299"></a>299 </span><span class="uncovered0"><a
    name="line300"></a>300 end </span><span class="inferred1"><a
    name="line301"></a>301 </span><span class="marked0"><a
    name="line302"></a>302 def save_mask_and_warp </span><span
    class="uncovered1"><a name="line303"></a>303 logger.info &quot;save mask and
    warp&quot; </span><span class="uncovered0"><a name="line304"></a>304
    </span><span class="uncovered1"><a name="line305"></a>305 if
    params[:output].blank? </span><span class="uncovered0"><a
    name="line306"></a>306 render :text =&gt; &quot;Map not masked, have you
    drawn one on the map?&quot; </span><span class="uncovered1"><a
    name="line307"></a>307 else </span><span class="uncovered0"><a
    name="line308"></a>308 </span><span class="uncovered1"><a
    name="line309"></a>309 @map.save_mask(params[:output]) </span><span
    class="uncovered0"><a name="line310"></a>310 @map.mask! </span><span
    class="uncovered1"><a name="line311"></a>311 </span><span
    class="uncovered0"><a name="line312"></a>312 if @map.gcps.size.nil? ||
    @map.gcps.size &lt; 3 </span><span class="uncovered1"><a
    name="line313"></a>313 render :text =&gt; &quot;Map masked, but it needs
    more control points to rectify. Click the Rectify tab to add some.&quot;
    </span><span class="uncovered0"><a name="line314"></a>314 else </span><span
    class="uncovered1"><a name="line315"></a>315 params[:use_mask] =
    &quot;true&quot; </span><span class="uncovered0"><a name="line316"></a>316
    rectify #which gives us @rectify_success </span><span class="uncovered1"><a
    name="line317"></a>317 unless @rectify_success == true </span><span
    class="uncovered0"><a name="line318"></a>318 render :text =&gt;
    &quot;Something went wrong rectifying the map.&quot; </span><span
    class="uncovered1"><a name="line319"></a>319 else </span><span
    class="uncovered0"><a name="line320"></a>320 render :text =&gt; &quot;Map
    masked and rectified!&quot; </span><span class="uncovered1"><a
    name="line321"></a>321 end </span><span class="uncovered0"><a
    name="line322"></a>322 end </span><span class="uncovered1"><a
    name="line323"></a>323 end </span><span class="uncovered0"><a
    name="line324"></a>324 end </span><span class="inferred1"><a
    name="line325"></a>325 </span><span class="inferred0"><a
    name="line326"></a>326 </span><span class="inferred1"><a
    name="line327"></a>327 </span><span class="marked0"><a
    name="line328"></a>328 def rectify </span><span class="uncovered1"><a
    name="line329"></a>329 #gotta catch if user submits and there are no GCP's
    entered - done :) </span><span class="uncovered0"><a name="line330"></a>330
    #also </span><span class="uncovered1"><a name="line331"></a>331 ##catch if
    user submits a blank GCP. Message about minimum 3 ? </span><span
    class="uncovered0"><a name="line332"></a>332 #logger.info params.inspect
    </span><span class="uncovered1"><a name="line333"></a>333 resample_param =
    params[:resample_options] </span><span class="uncovered0"><a
    name="line334"></a>334 transform_param = params[:transform_options]
    </span><span class="uncovered1"><a name="line335"></a>335 masking_option =
    params[:mask] </span><span class="uncovered0"><a name="line336"></a>336
    resample_option = &quot;&quot; </span><span class="uncovered1"><a
    name="line337"></a>337 transform_option = &quot;&quot; </span><span
    class="uncovered0"><a name="line338"></a>338 case transform_param
    </span><span class="uncovered1"><a name="line339"></a>339 when
    &quot;auto&quot; </span><span class="uncovered0"><a name="line340"></a>340
    transform_option = &quot;&quot; </span><span class="uncovered1"><a
    name="line341"></a>341 when &quot;p1&quot; </span><span
    class="uncovered0"><a name="line342"></a>342 transform_option = &quot;
    -order 1 &quot; </span><span class="uncovered1"><a name="line343"></a>343
    when &quot;p2&quot; </span><span class="uncovered0"><a
    name="line344"></a>344 transform_option = &quot; -order 2 &quot;
    </span><span class="uncovered1"><a name="line345"></a>345 when
    &quot;p3&quot; </span><span class="uncovered0"><a name="line346"></a>346
    transform_option = &quot; -order 3 &quot; </span><span class="uncovered1"><a
    name="line347"></a>347 when &quot;tps&quot; </span><span
    class="uncovered0"><a name="line348"></a>348 transform_option = &quot; -tps
    &quot; </span><span class="uncovered1"><a name="line349"></a>349 else
    </span><span class="uncovered0"><a name="line350"></a>350 transform_option =
    &quot;&quot; </span><span class="uncovered1"><a name="line351"></a>351 end
    </span><span class="uncovered0"><a name="line352"></a>352 </span><span
    class="uncovered1"><a name="line353"></a>353 case resample_param
    </span><span class="uncovered0"><a name="line354"></a>354 when
    &quot;near&quot; </span><span class="uncovered1"><a name="line355"></a>355
    resample_option = &quot; -rn &quot; </span><span class="uncovered0"><a
    name="line356"></a>356 when &quot;bilinear&quot; </span><span
    class="uncovered1"><a name="line357"></a>357 resample_option = &quot; -rb
    &quot; </span><span class="uncovered0"><a name="line358"></a>358 when
    &quot;cubic&quot; </span><span class="uncovered1"><a name="line359"></a>359
    resample_option = &quot; -rc &quot; </span><span class="uncovered0"><a
    name="line360"></a>360 when &quot;cubicspline&quot; </span><span
    class="uncovered1"><a name="line361"></a>361 resample_option = &quot; -rcs
    &quot; </span><span class="uncovered0"><a name="line362"></a>362 when
    &quot;lanczos&quot; #its very very slow </span><span class="uncovered1"><a
    name="line363"></a>363 resample_option = &quot; -rn &quot; </span><span
    class="uncovered0"><a name="line364"></a>364 else </span><span
    class="uncovered1"><a name="line365"></a>365 resample_option = &quot;
    -rn&quot; </span><span class="uncovered0"><a name="line366"></a>366 end
    </span><span class="uncovered1"><a name="line367"></a>367 </span><span
    class="uncovered0"><a name="line368"></a>368 use_mask = params[:use_mask]
    </span><span class="uncovered1"><a name="line369"></a>369 @too_few = false
    </span><span class="uncovered0"><a name="line370"></a>370 if
    @map.gcps.size.nil? || @map.gcps.size &lt; 3 </span><span
    class="uncovered1"><a name="line371"></a>371 @too_few = true </span><span
    class="uncovered0"><a name="line372"></a>372 @notice_text = &quot;Sorry, the
    map needs at least three control points to be able to rectify it&quot;
    </span><span class="uncovered1"><a name="line373"></a>373 @output =
    @notice_text </span><span class="uncovered0"><a name="line374"></a>374 else
    </span><span class="uncovered1"><a name="line375"></a>375 if logged_in?
    </span><span class="uncovered0"><a name="line376"></a>376 um =
    current_user.my_maps.new(:map =&gt; @map) </span><span class="uncovered1"><a
    name="line377"></a>377 um.save </span><span class="uncovered0"><a
    name="line378"></a>378 # @map.users &lt;&lt; current_user # another way
    creating the relationship </span><span class="uncovered1"><a
    name="line379"></a>379 end </span><span class="uncovered0"><a
    name="line380"></a>380 </span><span class="uncovered1"><a
    name="line381"></a>381 if @map.warp! transform_option, resample_option,
    use_mask #,masking_option </span><span class="uncovered0"><a
    name="line382"></a>382 @notice_text = &quot;Map rectified!&quot;
    </span><span class="uncovered1"><a name="line383"></a>383 @rectify_success =
    true </span><span class="uncovered0"><a name="line384"></a>384 else
    </span><span class="uncovered1"><a name="line385"></a>385 @notice_text =
    &quot;Something went wrong rectifying the map.&quot; </span><span
    class="uncovered0"><a name="line386"></a>386 @rectify_success = false
    </span><span class="uncovered1"><a name="line387"></a>387 end </span><span
    class="uncovered0"><a name="line388"></a>388 </span><span
    class="uncovered1"><a name="line389"></a>389 redirect_to :action=&gt; :index
    unless request.xhr? </span><span class="uncovered0"><a
    name="line390"></a>390 </span><span class="uncovered1"><a
    name="line391"></a>391 end </span><span class="uncovered0"><a
    name="line392"></a>392 end </span><span class="inferred1"><a
    name="line393"></a>393 </span><span class="inferred0"><a
    name="line394"></a>394 </span><span class="inferred1"><a
    name="line395"></a>395 #################################################
    </span><span class="inferred0"><a name="line396"></a>396 #MAPSERVER methods.
    </span><span class="inferred1"><a name="line397"></a>397 #Checks to see if
    mapscript is available, then redirects to cgi, or does it itself.
    </span><span class="inferred0"><a name="line398"></a>398
    ############################################### </span><span
    class="marked1"><a name="line399"></a>399 begin </span><span
    class="marked0"><a name="line400"></a>400 include Mapscript if require
    'mapscript' </span><span class="marked1"><a name="line401"></a>401
    @@mapscript_exists = false #YES, this means that all requests will go to cgi
    (seems quicker) </span><span class="uncovered0"><a name="line402"></a>402
    rescue LoadError </span><span class="uncovered1"><a name="line403"></a>403
    @@mapscript_exists = false #YES, this means that all requests will go to cgi
    (seems quicker) </span><span class="uncovered0"><a name="line404"></a>404
    end </span><span class="inferred1"><a name="line405"></a>405 </span><span
    class="inferred0"><a name="line406"></a>406 </span><span class="marked1"><a
    name="line407"></a>407 def wms </span><span class="uncovered0"><a
    name="line408"></a>408 </span><span class="uncovered1"><a
    name="line409"></a>409 unless @@mapscript_exists </span><span
    class="uncovered0"><a name="line410"></a>410 mapserver_wms </span><span
    class="uncovered1"><a name="line411"></a>411 else </span><span
    class="uncovered0"><a name="line412"></a>412 @map = Map.find(params[:id])
    </span><span class="uncovered1"><a name="line413"></a>413 #status is
    additional query param to show the unwarped wms </span><span
    class="uncovered0"><a name="line414"></a>414 status =
    params[&quot;STATUS&quot;].to_s.downcase || &quot;unwarped&quot;
    </span><span class="uncovered1"><a name="line415"></a>415 ows =
    OWSRequest.new </span><span class="uncovered0"><a name="line416"></a>416
    </span><span class="uncovered1"><a name="line417"></a>417 ok_params =
    Hash.new </span><span class="uncovered0"><a name="line418"></a>418 #
    params.each {|k,v| k.upcase! } frozen string error </span><span
    class="uncovered1"><a name="line419"></a>419 params.each {|k,v|
    ok_params[k.upcase] = v } </span><span class="uncovered0"><a
    name="line420"></a>420 [:request, :version, :transparency, :service, :srs,
    :width, :height, :bbox, :format, :srs].each do |key| </span><span
    class="uncovered1"><a name="line421"></a>421 ows.setParameter(key.to_s,
    ok_params[key.to_s.upcase]) unless ok_params[key.to_s.upcase].nil?
    </span><span class="uncovered0"><a name="line422"></a>422 end </span><span
    class="uncovered1"><a name="line423"></a>423 </span><span
    class="uncovered0"><a name="line424"></a>424
    ows.setParameter(&quot;STYLES&quot;, &quot;&quot;) </span><span
    class="uncovered1"><a name="line425"></a>425
    ows.setParameter(&quot;LAYERS&quot;, &quot;image&quot;) </span><span
    class="uncovered0"><a name="line426"></a>426
    ows.setParameter(&quot;COVERAGE&quot;, &quot;image&quot;) </span><span
    class="uncovered1"><a name="line427"></a>427 </span><span
    class="uncovered0"><a name="line428"></a>428 mapsv =
    MapObj.new(File.join(RAILS_ROOT, '/db/maptemplates/wms.map')) </span><span
    class="uncovered1"><a name="line429"></a>429 projfile =
    File.join(RAILS_ROOT, '/lib/proj') </span><span class="uncovered0"><a
    name="line430"></a>430 mapsv.setConfigOption(&quot;PROJ_LIB&quot;, projfile)
    </span><span class="uncovered1"><a name="line431"></a>431
    #map.setProjection(&quot;init=epsg:900913&quot;) </span><span
    class="uncovered0"><a name="line432"></a>432 mapsv.applyConfigOptions
    </span><span class="uncovered1"><a name="line433"></a>433 rel_url_root =
    (ActionController::Base.relative_url_root.blank?)? '' :
    ActionController::Base.relative_url_root </span><span class="uncovered0"><a
    name="line434"></a>434 mapsv.setMetaData(&quot;wms_onlineresource&quot;,
    </span><span class="uncovered1"><a name="line435"></a>435
    &quot;http://&quot; + request.host_with_port + rel_url_root +
    &quot;/maps/wms/#{@map.id}&quot;) </span><span class="uncovered0"><a
    name="line436"></a>436 </span><span class="uncovered1"><a
    name="line437"></a>437 raster = LayerObj.new(mapsv) </span><span
    class="uncovered0"><a name="line438"></a>438 raster.name = &quot;image&quot;
    </span><span class="uncovered1"><a name="line439"></a>439 raster.type =
    MS_LAYER_RASTER; </span><span class="uncovered0"><a name="line440"></a>440
    </span><span class="uncovered1"><a name="line441"></a>441 if status ==
    &quot;unwarped&quot; </span><span class="uncovered0"><a
    name="line442"></a>442 raster.data = @map.unwarped_filename </span><span
    class="uncovered1"><a name="line443"></a>443 </span><span
    class="uncovered0"><a name="line444"></a>444 else #show the warped map
    </span><span class="uncovered1"><a name="line445"></a>445 raster.data =
    @map.warped_filename </span><span class="uncovered0"><a
    name="line446"></a>446 end </span><span class="uncovered1"><a
    name="line447"></a>447 </span><span class="uncovered0"><a
    name="line448"></a>448 raster.status = MS_ON </span><span
    class="uncovered1"><a name="line449"></a>449 raster.dump = MS_TRUE
    </span><span class="uncovered0"><a name="line450"></a>450
    raster.metadata.set('wcs_formats', 'GEOTIFF') </span><span
    class="uncovered1"><a name="line451"></a>451
    raster.metadata.set('wms_title', @map.title) </span><span
    class="uncovered0"><a name="line452"></a>452 raster.metadata.set('wms_srs',
    'EPSG:4326 EPSG:4269 EPSG:900913') </span><span class="uncovered1"><a
    name="line453"></a>453 raster.debug= MS_TRUE </span><span
    class="uncovered0"><a name="line454"></a>454 </span><span
    class="uncovered1"><a name="line455"></a>455 msIO_installStdoutToBuffer
    </span><span class="uncovered0"><a name="line456"></a>456 result =
    mapsv.OWSDispatch(ows) </span><span class="uncovered1"><a
    name="line457"></a>457 content_type = msIO_stripStdoutBufferContentType ||
    &quot;text/plain&quot; </span><span class="uncovered0"><a
    name="line458"></a>458 result_data = msIO_getStdoutBufferBytes </span><span
    class="uncovered1"><a name="line459"></a>459 </span><span
    class="uncovered0"><a name="line460"></a>460 send_data result_data, :type
    =&gt; content_type, :disposition =&gt; &quot;inline&quot; </span><span
    class="uncovered1"><a name="line461"></a>461 msIO_resetHandlers </span><span
    class="uncovered0"><a name="line462"></a>462 end </span><span
    class="uncovered1"><a name="line463"></a>463 </span><span
    class="uncovered0"><a name="line464"></a>464 end </span><span
    class="inferred1"><a name="line465"></a>465 </span><span
    class="inferred0"><a name="line466"></a>466 </span><span
    class="inferred1"><a name="line467"></a>467
    ################################### </span><span class="inferred0"><a
    name="line468"></a>468 #private </span><span class="inferred1"><a
    name="line469"></a>469 ################################## </span><span
    class="inferred0"><a name="line470"></a>470 </span><span class="marked1"><a
    name="line471"></a>471 private </span><span class="inferred0"><a
    name="line472"></a>472 </span><span class="inferred1"><a
    name="line473"></a>473 </span><span class="marked0"><a
    name="line474"></a>474 def mapserver_wms </span><span class="uncovered1"><a
    name="line475"></a>475 #use Map.map_file_path so we don't have to do a db
    call </span><span class="uncovered0"><a name="line476"></a>476 status =
    params[&quot;STATUS&quot;].to_s.downcase || &quot;unwarped&quot;
    </span><span class="uncovered1"><a name="line477"></a>477 styles =
    &quot;&amp;styles=&quot; # required to stop mapserver being pedantic on
    older versions </span><span class="uncovered0"><a name="line478"></a>478 if
    status == &quot;unwarped&quot; </span><span class="uncovered1"><a
    name="line479"></a>479 mapserver_url = '/cgi/mapserv.cgi' + '?map=' +
    Map.mapfile_path(params[:id]) + styles + &quot;&amp;layers=&quot; +
    params[:id].to_s + &quot;_original&quot; </span><span class="uncovered0"><a
    name="line480"></a>480 else </span><span class="uncovered1"><a
    name="line481"></a>481 mapserver_url = '/cgi/mapserv.cgi' + '?map=' +
    Map.mapfile_path(params[:id]) + styles + &quot;&amp;layers=&quot; +
    params[:id].to_s </span><span class="uncovered0"><a name="line482"></a>482
    end </span><span class="uncovered1"><a name="line483"></a>483 mapserver_url
    += &quot;&amp;&quot;+request.query_string </span><span class="uncovered0"><a
    name="line484"></a>484 redirect_to(mapserver_url) </span><span
    class="uncovered1"><a name="line485"></a>485 end </span><span
    class="inferred0"><a name="line486"></a>486 </span><span class="marked1"><a
    name="line487"></a>487 def set_session_link_back link_url </span><span
    class="marked0"><a name="line488"></a>488 session[:link_back] = link_url
    </span><span class="inferred1"><a name="line489"></a>489 end </span><span
    class="inferred0"><a name="line490"></a>490 </span><span class="marked1"><a
    name="line491"></a>491 def check_link_back </span><span
    class="uncovered0"><a name="line492"></a>492 @link_back =
    session[:link_back] </span><span class="uncovered1"><a
    name="line493"></a>493 if @link_back.nil? </span><span class="uncovered0"><a
    name="line494"></a>494 @link_back = url_for(:action =&gt; 'index')
    </span><span class="uncovered1"><a name="line495"></a>495 end </span><span
    class="uncovered0"><a name="line496"></a>496 </span><span
    class="uncovered1"><a name="line497"></a>497 session[:link_back] =
    @link_back </span><span class="uncovered0"><a name="line498"></a>498 end
    </span><span class="inferred1"><a name="line499"></a>499 </span><span
    class="inferred0"><a name="line500"></a>500 #only allow editing by a user if
    the user owns it, or if no one owns it </span><span class="marked1"><a
    name="line501"></a>501 def check_if_map_is_editable </span><span
    class="uncovered0"><a name="line502"></a>502 </span><span
    class="uncovered1"><a name="line503"></a>503 if logged_in? and
    (current_user.own_this_map?(params[:id]) or
    current_user.has_role?(&quot;editor&quot;)) </span><span
    class="uncovered0"><a name="line504"></a>504 @map = Map.find(params[:id])
    </span><span class="uncovered1"><a name="line505"></a>505 elsif
    Map.find(params[:id]).owner.nil? </span><span class="uncovered0"><a
    name="line506"></a>506 @map = Map.find(params[:id]) </span><span
    class="uncovered1"><a name="line507"></a>507 </span><span
    class="uncovered0"><a name="line508"></a>508 else </span><span
    class="uncovered1"><a name="line509"></a>509 flash[:notice] = &quot;Sorry,
    you cannot edit other people's maps&quot; </span><span class="uncovered0"><a
    name="line510"></a>510 redirect_to map_path </span><span
    class="uncovered1"><a name="line511"></a>511 end </span><span
    class="uncovered0"><a name="line512"></a>512 end </span><span
    class="inferred1"><a name="line513"></a>513 </span><span class="marked0"><a
    name="line514"></a>514 def find_map_if_available </span><span
    class="uncovered1"><a name="line515"></a>515 @map = Map.find(params[:id])
    </span><span class="uncovered0"><a name="line516"></a>516 if
    @map.status.nil? or @map.status == :unloaded or @map.status == :loading
    </span><span class="uncovered1"><a name="line517"></a>517 # flash[:notice] =
    &quot;&quot; </span><span class="uncovered0"><a name="line518"></a>518
    redirect_to map_path </span><span class="uncovered1"><a
    name="line519"></a>519 end </span><span class="uncovered0"><a
    name="line520"></a>520 end </span><span class="uncovered1"><a
    name="line521"></a>521 </span><span class="uncovered0"><a
    name="line522"></a>522 end </span></pre>
    <hr />
    <p> Generated using the <a href='http://eigenclass.org/hiki.rb?rcov'> rcov
    code coverage analysis tool for Ruby </a> version 0.8.1.2. </p>
    <p>
      <a href='http://validator.w3.org/check/referer'>
        <img src='http://www.w3.org/Icons/valid-xhtml10' height='31' alt='Valid XHTML 1.0!' width='88' />
      </a>
      <a href='http://jigsaw.w3.org/css-validator/check/referer'>
        <img src='http://jigsaw.w3.org/css-validator/images/vcss' alt='Valid CSS!' style='border:0;width:88px;height:31px' />
      </a>
    </p>
  </body>
</html>
