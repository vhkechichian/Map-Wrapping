<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>
      app/models/map.rb - C0 code coverage information
    </title>
    <style type='text/css'>
      body { background-color: rgb(240, 240, 245); }
    </style>
    <style type='text/css'>
      span.cross-ref-title { font-size: 140%; } span.cross-ref a {
      text-decoration: none; } span.cross-ref { background-color:#f3f7fa;
      border: 1px dashed #333; margin: 1em; padding: 0.5em; overflow: hidden; }
      a.crossref-toggle { text-decoration: none; } span.marked0 {
      background-color: rgb(185, 210, 200); display: block; } span.marked1 {
      background-color: rgb(190, 215, 205); display: block; } span.inferred0 {
      background-color: rgb(175, 200, 200); display: block; } span.inferred1 {
      background-color: rgb(180, 205, 205); display: block; } span.uncovered0 {
      background-color: rgb(225, 110, 110); display: block; } span.uncovered1 {
      background-color: rgb(235, 120, 120); display: block; } span.overview {
      border-bottom: 8px solid black; } div.overview { border-bottom: 8px solid
      black; } body { font-family: verdana, arial, helvetica; } div.footer {
      font-size: 68%; margin-top: 1.5em; } h1, h2, h3, h4, h5, h6 {
      margin-bottom: 0.5em; } h5 { margin-top: 0.5em; } .hidden { display: none;
      } div.separator { height: 10px; } /* Commented out for better readability,
      esp. on IE */ /* table tr td, table tr th { font-size: 68%; } td.value
      table tr td { font-size: 11px; } */ table.percent_graph { height: 12px;
      border: #808080 1px solid; empty-cells: show; } table.percent_graph
      td.covered { height: 10px; background: #00f000; } table.percent_graph
      td.uncovered { height: 10px; background: #e00000; } table.percent_graph
      td.NA { height: 10px; background: #eaeaea; } table.report {
      border-collapse: collapse; width: 100%; } table.report td.heading {
      background: #dcecff; border: #d0d0d0 1px solid; font-weight: bold;
      text-align: center; } table.report td.heading:hover { background: #c0ffc0;
      } table.report td.text { border: #d0d0d0 1px solid; } table.report
      td.value, table.report td.lines_total, table.report td.lines_code {
      text-align: right; border: #d0d0d0 1px solid; } table.report tr.light {
      background-color: rgb(240, 240, 245); } table.report tr.dark {
      background-color: rgb(230, 230, 235); } 
    </style>
    <script type='text/javascript'>
       // <![CDATA[ function toggleCode( id ) { if ( document.getElementById )
      elem = document.getElementById( id ); else if ( document.all ) elem =
      eval( "document.all." + id ); else return false; elemStyle = elem.style;
      if ( elemStyle.display != "block" ) { elemStyle.display = "block" } else {
      elemStyle.display = "none" } return true; } // Make cross-references
      hidden by default document.writeln( "<style
      type=\"text/css\">span.cross-ref { display: none }</style>" ) // ]]> 
    </script>
    <style type='text/css'>
      span.run0 { background-color: rgb(178, 204, 255); display: block; }
      span.run1 { background-color: rgb(178, 206, 255); display: block; }
      span.run2 { background-color: rgb(178, 209, 255); display: block; }
      span.run3 { background-color: rgb(178, 211, 255); display: block; }
      span.run4 { background-color: rgb(178, 214, 255); display: block; }
      span.run5 { background-color: rgb(178, 218, 255); display: block; }
      span.run6 { background-color: rgb(178, 220, 255); display: block; }
      span.run7 { background-color: rgb(178, 223, 255); display: block; }
      span.run8 { background-color: rgb(178, 225, 255); display: block; }
      span.run9 { background-color: rgb(178, 228, 255); display: block; }
      span.run10 { background-color: rgb(178, 232, 255); display: block; }
      span.run11 { background-color: rgb(178, 234, 255); display: block; }
      span.run12 { background-color: rgb(178, 237, 255); display: block; }
      span.run13 { background-color: rgb(178, 239, 255); display: block; }
      span.run14 { background-color: rgb(178, 242, 255); display: block; }
      span.run15 { background-color: rgb(178, 246, 255); display: block; }
      span.run16 { background-color: rgb(178, 248, 255); display: block; }
      span.run17 { background-color: rgb(178, 251, 255); display: block; }
      span.run18 { background-color: rgb(178, 253, 255); display: block; }
      span.run19 { background-color: rgb(178, 255, 253); display: block; }
      span.run20 { background-color: rgb(178, 255, 249); display: block; }
      span.run21 { background-color: rgb(178, 255, 247); display: block; }
      span.run22 { background-color: rgb(178, 255, 244); display: block; }
      span.run23 { background-color: rgb(178, 255, 242); display: block; }
      span.run24 { background-color: rgb(178, 255, 239); display: block; }
      span.run25 { background-color: rgb(178, 255, 235); display: block; }
      span.run26 { background-color: rgb(178, 255, 233); display: block; }
      span.run27 { background-color: rgb(178, 255, 230); display: block; }
      span.run28 { background-color: rgb(178, 255, 228); display: block; }
      span.run29 { background-color: rgb(178, 255, 225); display: block; }
      span.run30 { background-color: rgb(178, 255, 221); display: block; }
      span.run31 { background-color: rgb(178, 255, 219); display: block; }
      span.run32 { background-color: rgb(178, 255, 216); display: block; }
      span.run33 { background-color: rgb(178, 255, 214); display: block; }
      span.run34 { background-color: rgb(178, 255, 211); display: block; }
      span.run35 { background-color: rgb(178, 255, 207); display: block; }
      span.run36 { background-color: rgb(178, 255, 205); display: block; }
      span.run37 { background-color: rgb(178, 255, 202); display: block; }
      span.run38 { background-color: rgb(178, 255, 200); display: block; }
      span.run39 { background-color: rgb(178, 255, 197); display: block; }
      span.run40 { background-color: rgb(178, 255, 193); display: block; }
      span.run41 { background-color: rgb(178, 255, 191); display: block; }
      span.run42 { background-color: rgb(178, 255, 188); display: block; }
      span.run43 { background-color: rgb(178, 255, 186); display: block; }
      span.run44 { background-color: rgb(178, 255, 183); display: block; }
      span.run45 { background-color: rgb(178, 255, 179); display: block; }
      span.run46 { background-color: rgb(179, 255, 178); display: block; }
      span.run47 { background-color: rgb(182, 255, 178); display: block; }
      span.run48 { background-color: rgb(184, 255, 178); display: block; }
      span.run49 { background-color: rgb(187, 255, 178); display: block; }
      span.run50 { background-color: rgb(191, 255, 178); display: block; }
      span.run51 { background-color: rgb(193, 255, 178); display: block; }
      span.run52 { background-color: rgb(196, 255, 178); display: block; }
      span.run53 { background-color: rgb(198, 255, 178); display: block; }
      span.run54 { background-color: rgb(201, 255, 178); display: block; }
      span.run55 { background-color: rgb(205, 255, 178); display: block; }
      span.run56 { background-color: rgb(207, 255, 178); display: block; }
      span.run57 { background-color: rgb(210, 255, 178); display: block; }
      span.run58 { background-color: rgb(212, 255, 178); display: block; }
      span.run59 { background-color: rgb(215, 255, 178); display: block; }
      span.run60 { background-color: rgb(219, 255, 178); display: block; }
      span.run61 { background-color: rgb(221, 255, 178); display: block; }
      span.run62 { background-color: rgb(224, 255, 178); display: block; }
      span.run63 { background-color: rgb(226, 255, 178); display: block; }
      span.run64 { background-color: rgb(229, 255, 178); display: block; }
      span.run65 { background-color: rgb(233, 255, 178); display: block; }
      span.run66 { background-color: rgb(235, 255, 178); display: block; }
      span.run67 { background-color: rgb(238, 255, 178); display: block; }
      span.run68 { background-color: rgb(240, 255, 178); display: block; }
      span.run69 { background-color: rgb(243, 255, 178); display: block; }
      span.run70 { background-color: rgb(247, 255, 178); display: block; }
      span.run71 { background-color: rgb(249, 255, 178); display: block; }
      span.run72 { background-color: rgb(252, 255, 178); display: block; }
      span.run73 { background-color: rgb(255, 255, 178); display: block; }
      span.run74 { background-color: rgb(255, 252, 178); display: block; }
      span.run75 { background-color: rgb(255, 248, 178); display: block; }
      span.run76 { background-color: rgb(255, 246, 178); display: block; }
      span.run77 { background-color: rgb(255, 243, 178); display: block; }
      span.run78 { background-color: rgb(255, 240, 178); display: block; }
      span.run79 { background-color: rgb(255, 238, 178); display: block; }
      span.run80 { background-color: rgb(255, 234, 178); display: block; }
      span.run81 { background-color: rgb(255, 232, 178); display: block; }
      span.run82 { background-color: rgb(255, 229, 178); display: block; }
      span.run83 { background-color: rgb(255, 226, 178); display: block; }
      span.run84 { background-color: rgb(255, 224, 178); display: block; }
      span.run85 { background-color: rgb(255, 220, 178); display: block; }
      span.run86 { background-color: rgb(255, 218, 178); display: block; }
      span.run87 { background-color: rgb(255, 215, 178); display: block; }
      span.run88 { background-color: rgb(255, 212, 178); display: block; }
      span.run89 { background-color: rgb(255, 210, 178); display: block; }
      span.run90 { background-color: rgb(255, 206, 178); display: block; }
      span.run91 { background-color: rgb(255, 204, 178); display: block; }
      span.run92 { background-color: rgb(255, 201, 178); display: block; }
      span.run93 { background-color: rgb(255, 198, 178); display: block; }
      span.run94 { background-color: rgb(255, 196, 178); display: block; }
      span.run95 { background-color: rgb(255, 192, 178); display: block; }
      span.run96 { background-color: rgb(255, 189, 178); display: block; }
      span.run97 { background-color: rgb(255, 187, 178); display: block; }
      span.run98 { background-color: rgb(255, 184, 178); display: block; }
      span.run99 { background-color: rgb(255, 182, 178); display: block; }
      span.run100 { background-color: rgb(255, 178, 178); display: block; } 
    </style>
  </head>
  <body>
    <h3>
      C0 code coverage information
    </h3>
    <p>
      Generated on Mon Mar 02 12:22:16 +0000 2009 with 
      <a href='http://eigenclass.org/hiki/rcov'>
        rcov 0.8.1.2
      </a>
    </p>
    <hr />
    <pre><span class='marked0'>Code reported as executed by Ruby looks like
    this... </span><span class='marked1'>and this: this line is also marked as
    covered. </span><span class='inferred0'>Lines considered as run by rcov, but
    not reported by Ruby, look like this, </span><span class='inferred1'>and
    this: these lines were inferred by rcov (using simple heuristics).
    </span><span class='uncovered0'>Finally, here&apos;s a line marked as not
    executed. </span></pre> 
    <table class='report'> <thead> <tr> <td class='heading'> Name </td> <td
    class='heading'> Total lines </td> <td class='heading'> Lines of code </td>
    <td class='heading'> Total coverage </td> <td class='heading'> Code coverage
    </td> </tr> </thead> <tbody> <tr class='light'> <td> <a
    href='app-models-map_rb.html'> app/models/map.rb </a> </td> <td
    class='lines_total'> <tt> 655 </tt> </td> <td class='lines_code'> <tt> 459
    </tt> </td> <td> <table cellspacing='0' align='right' cellpadding='0'> <tr>
    <td> <tt class='coverage_total'> 31.0% </tt> &nbsp; </td> <td> <table
    class='percent_graph' cellspacing='0' width='100' cellpadding='0'> <tr> <td
    class='covered' width='31' /> <td class='uncovered' width='69' /> </tr>
    </table> </td> </tr> </table> </td> <td> <table cellspacing='0'
    align='right' cellpadding='0'> <tr> <td> <tt class='coverage_code'> 20.3%
    </tt> &nbsp; </td> <td> <table class='percent_graph' cellspacing='0'
    width='100' cellpadding='0'> <tr> <td class='covered' width='20' /> <td
    class='uncovered' width='80' /> </tr> </table> </td> </tr> </table> </td>
    </tr> </tbody> </table><pre><span class="marked1"><a name="line1"></a> 1
    require &quot;open3&quot; </span><span class="marked0"><a name="line2"></a>
    2 require &quot;ftools&quot; </span><span class="marked1"><a
    name="line3"></a> 3 require &quot;matrix&quot; </span><span
    class="marked0"><a name="line4"></a> 4 require 'erb' </span><span
    class="marked1"><a name="line5"></a> 5 include ErrorCalculator </span><span
    class="inferred0"><a name="line6"></a> 6 </span><span class="inferred1"><a
    name="line7"></a> 7 </span><span class="marked0"><a name="line8"></a> 8
    class Map &lt; ActiveRecord::Base </span><span class="marked1"><a
    name="line9"></a> 9 has_many :my_maps, :dependent =&gt; :destroy
    </span><span class="marked0"><a name="line10"></a> 10 has_many :users,
    :through =&gt; :my_maps </span><span class="marked1"><a name="line11"></a>
    11 belongs_to :owner, :class_name =&gt; &quot;User&quot; </span><span
    class="marked0"><a name="line12"></a> 12 has_one :user, :through =&gt;
    :my_maps </span><span class="marked1"><a name="line13"></a> 13 has_many
    :gcps, :dependent =&gt; :destroy #gcps also destroyed if map is </span><span
    class="marked0"><a name="line14"></a> 14 acts_as_taggable </span><span
    class="marked1"><a name="line15"></a> 15 has_attached_file :upload, :styles
    =&gt; { :medium =&gt; [&quot;300x300&gt;&quot;, :png ], </span><span
    class="inferred0"><a name="line16"></a> 16 :thumb =&gt;
    [&quot;100x100&gt;&quot;, :png]} </span><span class="marked1"><a
    name="line17"></a> 17 attr_protected :upload_file_name,
    :upload_content_type, :upload_size </span><span class="inferred0"><a
    name="line18"></a> 18 </span><span class="inferred1"><a name="line19"></a>
    19 </span><span class="inferred0"><a name="line20"></a> 20 #maximum
    dimension size for height or width. it will resize if one of the dimensions
    is over this value </span><span class="inferred1"><a name="line21"></a> 21
    #define MAX_ATTACHMENT_SIZE in your config/environments/whatever.rb file
    </span><span class="inferred0"><a name="line22"></a> 22 </span><span
    class="marked1"><a name="line23"></a> 23 validates_attachment_size(:upload,
    :less_than =&gt; MAX_ATTACHMENT_SIZE) if defined?(MAX_ATTACHMENT_SIZE)
    </span><span class="inferred0"><a name="line24"></a> 24 </span><span
    class="marked1"><a name="line25"></a> 25 acts_as_audited :except =&gt;
    [:filename] </span><span class="inferred0"><a name="line26"></a> 26
    </span><span class="marked1"><a name="line27"></a> 27 named_scope :public,
    :conditions =&gt; ['public = ?', true] </span><span class="inferred0"><a
    name="line28"></a> 28 </span><span class="marked1"><a name="line29"></a> 29
    acts_as_enum :status, [:unloaded, :loading, :available, :warping, :warped,
    :published] </span><span class="marked0"><a name="line30"></a> 30
    acts_as_enum :mask_status, [:unmasked, :masking, :masked] </span><span
    class="inferred1"><a name="line31"></a> 31 </span><span class="marked0"><a
    name="line32"></a> 32 default_values :status =&gt; :unloaded, :mask_status
    =&gt; :unmasked </span><span class="inferred1"><a name="line33"></a> 33
    </span><span class="marked0"><a name="line34"></a> 34 attr_accessor :error
    </span><span class="inferred1"><a name="line35"></a> 35 </span><span
    class="marked0"><a name="line36"></a> 36 validates_presence_of :title
    </span><span class="inferred1"><a name="line37"></a> 37 </span><span
    class="marked0"><a name="line38"></a> 38 before_create :save_dimensions
    </span><span class="marked1"><a name="line39"></a> 39 after_create
    :setup_image </span><span class="marked0"><a name="line40"></a> 40
    after_destroy :delete_images </span><span class="marked1"><a
    name="line41"></a> 41 after_destroy :delete_map </span><span
    class="inferred0"><a name="line42"></a> 42 </span><span class="inferred1"><a
    name="line43"></a> 43 </span><span class="inferred0"><a name="line44"></a>
    44 ############################################# </span><span
    class="inferred1"><a name="line45"></a> 45 #CUSTOM VALIDATIONS </span><span
    class="inferred0"><a name="line46"></a> 46
    ############################################# </span><span
    class="inferred1"><a name="line47"></a> 47 </span><span class="marked0"><a
    name="line48"></a> 48 def validate_on_create </span><span
    class="uncovered1"><a name="line49"></a> 49 errors.add(:filename, &quot;is
    already being used&quot;) if Map.find_by_filename(upload.original_filename)
    </span><span class="uncovered0"><a name="line50"></a> 50 end </span><span
    class="inferred1"><a name="line51"></a> 51 </span><span class="inferred0"><a
    name="line52"></a> 52 </span><span class="inferred1"><a name="line53"></a>
    53 ############################################# </span><span
    class="inferred0"><a name="line54"></a> 54 #FILTERS </span><span
    class="inferred1"><a name="line55"></a> 55
    ############################################# </span><span
    class="inferred0"><a name="line56"></a> 56 </span><span class="marked1"><a
    name="line57"></a> 57 def save_dimensions </span><span class="uncovered0"><a
    name="line58"></a> 58 if [&quot;image/jpeg&quot;, &quot;image/tiff&quot;,
    &quot;image/png&quot;, &quot;image/gif&quot;,
    &quot;image/bmp&quot;].include?(upload.content_type.to_s) </span><span
    class="uncovered1"><a name="line59"></a> 59 self.width = upload.width
    </span><span class="uncovered0"><a name="line60"></a> 60 self.height =
    upload.height </span><span class="uncovered1"><a name="line61"></a> 61 end
    </span><span class="uncovered0"><a name="line62"></a> 62 self.status =
    :available </span><span class="uncovered1"><a name="line63"></a> 63 end
    </span><span class="inferred0"><a name="line64"></a> 64 </span><span
    class="inferred1"><a name="line65"></a> 65 #this gets the upload, detects
    what it is, and converts to a tif, if necessary. </span><span
    class="inferred0"><a name="line66"></a> 66 #Although an uploaded tif with
    existing geo fields may confuse things </span><span class="marked1"><a
    name="line67"></a> 67 def setup_image </span><span class="uncovered0"><a
    name="line68"></a> 68 logger.info &quot;setup_image &quot; </span><span
    class="uncovered1"><a name="line69"></a> 69 self.filename =
    upload.original_filename </span><span class="uncovered0"><a
    name="line70"></a> 70 save! </span><span class="uncovered1"><a
    name="line71"></a> 71 if self.upload? </span><span class="uncovered0"><a
    name="line72"></a> 72 </span><span class="uncovered1"><a name="line73"></a>
    73 if defined?(MAX_DIMENSION) &amp;&amp; (width &gt; MAX_DIMENSION || height
    &gt; MAX_DIMENSION) </span><span class="uncovered0"><a name="line74"></a> 74
    logger.info &quot;Image is too big, so going to resize &quot; </span><span
    class="uncovered1"><a name="line75"></a> 75 if width &gt; height
    </span><span class="uncovered0"><a name="line76"></a> 76 dest_width =
    MAX_DIMENSION </span><span class="uncovered1"><a name="line77"></a> 77
    dest_height = (dest_width.to_f / width.to_f) * height.to_f </span><span
    class="uncovered0"><a name="line78"></a> 78 else </span><span
    class="uncovered1"><a name="line79"></a> 79 dest_height = MAX_DIMENSION
    </span><span class="uncovered0"><a name="line80"></a> 80 dest_width =
    (dest_height.to_f / height.to_f) * width.to_f </span><span
    class="uncovered1"><a name="line81"></a> 81 end </span><span
    class="uncovered0"><a name="line82"></a> 82 self.width = dest_width
    </span><span class="uncovered1"><a name="line83"></a> 83 self.height =
    dest_height </span><span class="uncovered0"><a name="line84"></a> 84 save!
    </span><span class="uncovered1"><a name="line85"></a> 85 outsize =
    &quot;-outsize #{dest_width.to_i} #{dest_height.to_i}&quot; </span><span
    class="uncovered0"><a name="line86"></a> 86 else </span><span
    class="uncovered1"><a name="line87"></a> 87 outsize = &quot;&quot;
    </span><span class="uncovered0"><a name="line88"></a> 88 end </span><span
    class="uncovered1"><a name="line89"></a> 89 </span><span
    class="uncovered0"><a name="line90"></a> 90 orig_ext =
    File.extname(self.upload_file_name).to_s.downcase </span><span
    class="uncovered1"><a name="line91"></a> 91 i_stdin, i_stdout, i_stderr =
    </span><span class="uncovered0"><a name="line92"></a> 92 Open3::popen3(
    &quot;#{GDAL_PATH}gdalinfo #{self.upload.path} -nomd -noct&quot; )
    </span><span class="uncovered1"><a name="line93"></a> 93 gdalinfo_output =
    i_stdout.readlines.to_s </span><span class="uncovered0"><a
    name="line94"></a> 94
    gdalinfo_output.include?(&quot;ColorInterp=Gray&quot;)? gray = true : gray =
    false </span><span class="uncovered1"><a name="line95"></a> 95 </span><span
    class="uncovered0"><a name="line96"></a> 96 # if orig_ext ==
    &quot;.gif&quot; &amp;&amp;
    gdalinfo_output.include?(&quot;ColorInterp=Palette&quot;) </span><span
    class="uncovered1"><a name="line97"></a> 97 # logger.info(&quot;Its a
    paletted gif, converting to truecolor png before&quot;) </span><span
    class="uncovered0"><a name="line98"></a> 98 # `convert #{self.upload.path}
    -type TrueColor #{self.upload.path + &quot;_tmp.png&quot;}` </span><span
    class="uncovered1"><a name="line99"></a> 99 # File.copy self.upload.path +
    &quot;_tmp.png&quot;, self.upload.path </span><span class="uncovered0"><a
    name="line100"></a>100 # end </span><span class="uncovered1"><a
    name="line101"></a>101 # if gray == true &amp;&amp; (orig_ext !=
    &quot;.tif&quot; || orig_ext != &quot;.tiff&quot;) </span><span
    class="uncovered0"><a name="line102"></a>102 # logger.info(&quot;converting
    to truecolor&quot;) </span><span class="uncovered1"><a
    name="line103"></a>103 # `convert #{self.upload.path} -type TrueColor
    #{self.upload.path + &quot;_tmp&quot;}` </span><span class="uncovered0"><a
    name="line104"></a>104 # File.copy self.upload.path + &quot;_tmp&quot;,
    self.upload.path </span><span class="uncovered1"><a name="line105"></a>105 #
    end </span><span class="uncovered0"><a name="line106"></a>106 </span><span
    class="uncovered1"><a name="line107"></a>107 tiffed_filename = (orig_ext ==
    &quot;.tif&quot; || orig_ext == &quot;.tiff&quot;)? self.upload_file_name :
    self.upload_file_name + &quot;.tif&quot; </span><span class="uncovered0"><a
    name="line108"></a>108 tiffed_file_path = File.join(maps_dir ,
    tiffed_filename) </span><span class="uncovered1"><a name="line109"></a>109
    </span><span class="uncovered0"><a name="line110"></a>110 if (orig_ext ==
    &quot;.tif&quot; || orig_ext == &quot;.tiff&quot;) &amp;&amp; gray == false
    &amp;&amp; outsize.empty? == true </span><span class="uncovered1"><a
    name="line111"></a>111 logger.info &quot;Upload is a TIF and is not gray,
    and is not oversized so just copy original&quot; </span><span
    class="uncovered0"><a name="line112"></a>112 self.filename =
    upload.original_filename </span><span class="uncovered1"><a
    name="line113"></a>113 File.copy self.upload.path, maps_dir </span><span
    class="uncovered0"><a name="line114"></a>114 else </span><span
    class="uncovered1"><a name="line115"></a>115 logger.info &quot;It's 1) a TIF
    and gray, or 2) its a normal image, either way, we convert to tiff&quot;
    </span><span class="uncovered0"><a name="line116"></a>116 # -co
    compress=DEFLATE for compression? </span><span class="uncovered1"><a
    name="line117"></a>117 ti_stdin, ti_stdout, ti_stderr = </span><span
    class="uncovered0"><a name="line118"></a>118 Open3::popen3(
    &quot;#{GDAL_PATH}gdal_translate #{self.upload.path} #{outsize} -co
    PHOTOMETRIC=RGB -co profile=baseline #{tiffed_file_path}&quot; )
    </span><span class="uncovered1"><a name="line119"></a>119 self.filename =
    tiffed_filename </span><span class="uncovered0"><a name="line120"></a>120
    end </span><span class="uncovered1"><a name="line121"></a>121 end
    </span><span class="uncovered0"><a name="line122"></a>122 </span><span
    class="uncovered1"><a name="line123"></a>123 save! </span><span
    class="uncovered0"><a name="line124"></a>124 save_mapfile </span><span
    class="uncovered1"><a name="line125"></a>125 end </span><span
    class="inferred0"><a name="line126"></a>126 </span><span
    class="inferred1"><a name="line127"></a>127 #paperclip plugin deletes the
    images when model is destroyed </span><span class="marked0"><a
    name="line128"></a>128 def delete_images </span><span class="uncovered1"><a
    name="line129"></a>129 logger.info &quot;Deleting map images&quot;
    </span><span class="uncovered0"><a name="line130"></a>130 if
    File.exists?(temp_filename) </span><span class="uncovered1"><a
    name="line131"></a>131 logger.info &quot;deleted temp&quot; </span><span
    class="uncovered0"><a name="line132"></a>132 File.delete(temp_filename)
    </span><span class="uncovered1"><a name="line133"></a>133 end </span><span
    class="uncovered0"><a name="line134"></a>134 if
    File.exists?(warped_filename) </span><span class="uncovered1"><a
    name="line135"></a>135 logger.info &quot;Deleted Map warped&quot;
    </span><span class="uncovered0"><a name="line136"></a>136
    File.delete(warped_filename) </span><span class="uncovered1"><a
    name="line137"></a>137 end </span><span class="uncovered0"><a
    name="line138"></a>138 if File.exists?(warped_png) </span><span
    class="uncovered1"><a name="line139"></a>139 logger.info &quot;deleted
    warped png&quot; </span><span class="uncovered0"><a name="line140"></a>140
    File.delete(warped_png) </span><span class="uncovered1"><a
    name="line141"></a>141 end </span><span class="uncovered0"><a
    name="line142"></a>142 if File.exists?(unwarped_filename) </span><span
    class="uncovered1"><a name="line143"></a>143 logger.info &quot;deleting
    unwarped&quot; </span><span class="uncovered0"><a name="line144"></a>144
    File.delete unwarped_filename </span><span class="uncovered1"><a
    name="line145"></a>145 end </span><span class="uncovered0"><a
    name="line146"></a>146 end </span><span class="inferred1"><a
    name="line147"></a>147 </span><span class="marked0"><a
    name="line148"></a>148 def delete_map </span><span class="uncovered1"><a
    name="line149"></a>149 logger.info &quot;Deleting mapfile&quot; </span><span
    class="uncovered0"><a name="line150"></a>150 </span><span
    class="uncovered1"><a name="line151"></a>151 end </span><span
    class="inferred0"><a name="line152"></a>152 </span><span
    class="inferred1"><a name="line153"></a>153
    ############################################# </span><span
    class="inferred0"><a name="line154"></a>154 #ACCESSOR METHODS </span><span
    class="inferred1"><a name="line155"></a>155
    ############################################# </span><span
    class="inferred0"><a name="line156"></a>156 </span><span class="marked1"><a
    name="line157"></a>157 def maps_dir </span><span class="uncovered0"><a
    name="line158"></a>158 File.join(RAILS_ROOT,
    &quot;/public/mapimages/src/&quot;) </span><span class="uncovered1"><a
    name="line159"></a>159 end </span><span class="inferred0"><a
    name="line160"></a>160 </span><span class="marked1"><a
    name="line161"></a>161 def dest_dir </span><span class="marked0"><a
    name="line162"></a>162 File.join(RAILS_ROOT,
    &quot;/public/mapimages/dst/&quot;) </span><span class="inferred1"><a
    name="line163"></a>163 end </span><span class="inferred0"><a
    name="line164"></a>164 </span><span class="marked1"><a
    name="line165"></a>165 def mapfile </span><span class="uncovered0"><a
    name="line166"></a>166 self.class.mapfile_path(self.id) </span><span
    class="uncovered1"><a name="line167"></a>167 #
    RAILS_ROOT+&quot;/db/mapfiles/&quot;+self.id.to_s+&quot;.map&quot;
    </span><span class="uncovered0"><a name="line168"></a>168 end </span><span
    class="inferred1"><a name="line169"></a>169 </span><span class="marked0"><a
    name="line170"></a>170 def warped_dir </span><span class="marked1"><a
    name="line171"></a>171 dest_dir </span><span class="inferred0"><a
    name="line172"></a>172 end </span><span class="inferred1"><a
    name="line173"></a>173 </span><span class="marked0"><a
    name="line174"></a>174 def unwarped_filename </span><span
    class="uncovered1"><a name="line175"></a>175 File.join(maps_dir,
    self.filename) </span><span class="uncovered0"><a name="line176"></a>176 end
    </span><span class="inferred1"><a name="line177"></a>177 </span><span
    class="marked0"><a name="line178"></a>178 def warped_filename </span><span
    class="marked1"><a name="line179"></a>179 File.join(warped_dir, id.to_s) +
    &quot;.tif&quot; </span><span class="inferred0"><a name="line180"></a>180
    end </span><span class="inferred1"><a name="line181"></a>181 </span><span
    class="marked0"><a name="line182"></a>182 def warped_png </span><span
    class="uncovered1"><a name="line183"></a>183 warped_filename +
    &quot;.png&quot; </span><span class="uncovered0"><a name="line184"></a>184
    end </span><span class="inferred1"><a name="line185"></a>185 </span><span
    class="marked0"><a name="line186"></a>186 def public_warped_tif_url
    </span><span class="uncovered1"><a name="line187"></a>187
    &quot;mapimages/dst/&quot;+id.to_s + &quot;.tif&quot; </span><span
    class="uncovered0"><a name="line188"></a>188 end </span><span
    class="marked1"><a name="line189"></a>189 def public_warped_png_url
    </span><span class="uncovered0"><a name="line190"></a>190
    public_warped_tif_url + &quot;.png&quot; </span><span class="uncovered1"><a
    name="line191"></a>191 end </span><span class="inferred0"><a
    name="line192"></a>192 </span><span class="marked1"><a
    name="line193"></a>193 def mask_file_format </span><span
    class="uncovered0"><a name="line194"></a>194 &quot;gml&quot; </span><span
    class="uncovered1"><a name="line195"></a>195 end </span><span
    class="inferred0"><a name="line196"></a>196 </span><span class="marked1"><a
    name="line197"></a>197 def temp_filename </span><span class="uncovered0"><a
    name="line198"></a>198 # self.full_filename + &quot;_temp&quot; </span><span
    class="uncovered1"><a name="line199"></a>199 File.join(warped_dir, id.to_s)
    + &quot;_temp&quot; </span><span class="uncovered0"><a
    name="line200"></a>200 end </span><span class="inferred1"><a
    name="line201"></a>201 </span><span class="marked0"><a
    name="line202"></a>202 def masking_file_gml </span><span
    class="uncovered1"><a name="line203"></a>203 File.join(RAILS_ROOT,
    &quot;/public/mapimages/&quot;, self.id.to_s) + &quot;.gml&quot;
    </span><span class="uncovered0"><a name="line204"></a>204 end </span><span
    class="inferred1"><a name="line205"></a>205 </span><span
    class="inferred0"><a name="line206"></a>206 #file made when rasterizing
    </span><span class="marked1"><a name="line207"></a>207 def masking_file_gfs
    </span><span class="uncovered0"><a name="line208"></a>208
    File.join(RAILS_ROOT, &quot;/public/mapimages/&quot;, self.id.to_s) +
    &quot;.gfs&quot; </span><span class="uncovered1"><a name="line209"></a>209
    end </span><span class="inferred0"><a name="line210"></a>210 </span><span
    class="marked1"><a name="line211"></a>211 def masked_src_filename
    </span><span class="uncovered0"><a name="line212"></a>212
    self.unwarped_filename + &quot;_masked&quot;; </span><span
    class="uncovered1"><a name="line213"></a>213 end </span><span
    class="inferred0"><a name="line214"></a>214 </span><span
    class="inferred1"><a name="line215"></a>215 </span><span
    class="inferred0"><a name="line216"></a>216
    ############################################# </span><span
    class="inferred1"><a name="line217"></a>217 #CLASS METHODS </span><span
    class="inferred0"><a name="line218"></a>218
    ############################################# </span><span
    class="inferred1"><a name="line219"></a>219 </span><span class="marked0"><a
    name="line220"></a>220 def self.mapfile_path(mapid) </span><span
    class="uncovered1"><a name="line221"></a>221
    File.join(RAILS_ROOT,&quot;/db/mapfiles/&quot;, mapid.to_s +
    &quot;.map&quot;) </span><span class="uncovered0"><a name="line222"></a>222
    end </span><span class="inferred1"><a name="line223"></a>223 </span><span
    class="marked0"><a name="line224"></a>224 def self.max_attachment_size
    </span><span class="uncovered1"><a name="line225"></a>225
    max_attachment_size = defined?(MAX_ATTACHMENT_SIZE)? MAX_ATTACHMENT_SIZE :
    nil </span><span class="uncovered0"><a name="line226"></a>226 end
    </span><span class="inferred1"><a name="line227"></a>227 </span><span
    class="marked0"><a name="line228"></a>228 def self.max_dimension
    </span><span class="uncovered1"><a name="line229"></a>229 max_dimension =
    defined?(MAX_DIMENSION)? MAX_DIMENSION : nil </span><span
    class="uncovered0"><a name="line230"></a>230 end </span><span
    class="inferred1"><a name="line231"></a>231 </span><span
    class="inferred0"><a name="line232"></a>232 #saves tilecache's config file
    </span><span class="marked1"><a name="line233"></a>233 def
    self.save_tilecache_config </span><span class="uncovered0"><a
    name="line234"></a>234 @maps = Map.all(:conditions =&gt; &quot;status =
    4&quot;) </span><span class="uncovered1"><a name="line235"></a>235
    </span><span class="uncovered0"><a name="line236"></a>236 cfg =
    File.open(RAILS_ROOT+&quot;/public/cgi/tilecache.cfg&quot;,
    File::CREAT|File::TRUNC|File::RDWR, 0666) </span><span class="uncovered1"><a
    name="line237"></a>237 template = File.open(RAILS_ROOT +
    &quot;/db/maptemplates/tilecache.text.erb&quot;).read </span><span
    class="uncovered0"><a name="line238"></a>238 cfg.puts
    ERB.new(template).result( binding ) </span><span class="uncovered1"><a
    name="line239"></a>239 cfg.close </span><span class="uncovered0"><a
    name="line240"></a>240 end </span><span class="inferred1"><a
    name="line241"></a>241 </span><span class="inferred0"><a
    name="line242"></a>242 </span><span class="inferred1"><a
    name="line243"></a>243 #############################################
    </span><span class="inferred0"><a name="line244"></a>244 #INSTANCE METHODS
    </span><span class="inferred1"><a name="line245"></a>245
    ############################################# </span><span
    class="inferred0"><a name="line246"></a>246 </span><span class="marked1"><a
    name="line247"></a>247 def available? </span><span class="uncovered0"><a
    name="line248"></a>248 return [:available,:warping,:warped].include?(status)
    </span><span class="uncovered1"><a name="line249"></a>249 end </span><span
    class="inferred0"><a name="line250"></a>250 </span><span class="marked1"><a
    name="line251"></a>251 def last_changed </span><span class="uncovered0"><a
    name="line252"></a>252 if self.gcps.size &gt; 0 </span><span
    class="uncovered1"><a name="line253"></a>253 self.gcps.last.created_at
    </span><span class="uncovered0"><a name="line254"></a>254 elsif
    !self.updated_at.nil? </span><span class="uncovered1"><a
    name="line255"></a>255 self.updated_at </span><span class="uncovered0"><a
    name="line256"></a>256 elsif !self.created_at.nil? </span><span
    class="uncovered1"><a name="line257"></a>257 self.created_at </span><span
    class="uncovered0"><a name="line258"></a>258 else </span><span
    class="uncovered1"><a name="line259"></a>259 Time.now </span><span
    class="uncovered0"><a name="line260"></a>260 end </span><span
    class="uncovered1"><a name="line261"></a>261 end </span><span
    class="inferred0"><a name="line262"></a>262 </span><span class="marked1"><a
    name="line263"></a>263 def save_bbox </span><span class="marked0"><a
    name="line264"></a>264 stdin, stdout, stderr =
    Open3::popen3(&quot;#{GDAL_PATH}gdalinfo #{warped_filename}&quot;)
    </span><span class="marked1"><a name="line265"></a>265 unless
    stderr.readlines.to_s.size &gt; 0 </span><span class="marked0"><a
    name="line266"></a>266 info = stdout.readlines.to_s </span><span
    class="marked1"><a name="line267"></a>267 string,west,south =
    info.match(/Lower Left\s+\(\s*([-.\d]+),\s+([-.\d]+)/).to_a </span><span
    class="marked0"><a name="line268"></a>268 string,east,north =
    info.match(/Upper Right\s+\(\s*([-.\d]+),\s+([-.\d]+)/).to_a </span><span
    class="marked1"><a name="line269"></a>269 self.bbox =
    [west,south,east,north].join(&quot;,&quot;) </span><span
    class="uncovered0"><a name="line270"></a>270 else </span><span
    class="uncovered1"><a name="line271"></a>271 logger.debug &quot;Save bbox
    error &quot;+ stderr.readlines.to_s </span><span class="uncovered0"><a
    name="line272"></a>272 end </span><span class="uncovered1"><a
    name="line273"></a>273 end </span><span class="inferred0"><a
    name="line274"></a>274 </span><span class="inferred1"><a
    name="line275"></a>275 </span><span class="marked0"><a
    name="line276"></a>276 def bounds </span><span class="marked1"><a
    name="line277"></a>277 if bbox.nil? </span><span class="marked0"><a
    name="line278"></a>278 x_array = [] </span><span class="marked1"><a
    name="line279"></a>279 y_array = [] </span><span class="marked0"><a
    name="line280"></a>280 self.gcps.each do |gcp| </span><span
    class="inferred1"><a name="line281"></a>281 #logger.info &quot;GCP lat
    #{gcp[:lat]} , lon #{gcp[:lon]} &quot; </span><span class="marked0"><a
    name="line282"></a>282 x_array &lt;&lt; gcp[:lat] </span><span
    class="marked1"><a name="line283"></a>283 y_array &lt;&lt; gcp[:lon]
    </span><span class="inferred0"><a name="line284"></a>284 end </span><span
    class="inferred1"><a name="line285"></a>285 #south, west, north, east
    </span><span class="marked0"><a name="line286"></a>286 our_bounds =
    [y_array.min ,x_array.min ,y_array.max, x_array.max].join ',' </span><span
    class="inferred1"><a name="line287"></a>287 else </span><span
    class="marked0"><a name="line288"></a>288 bbox </span><span
    class="inferred1"><a name="line289"></a>289 end </span><span
    class="inferred0"><a name="line290"></a>290 end </span><span
    class="inferred1"><a name="line291"></a>291 </span><span class="marked0"><a
    name="line292"></a>292 def converted_bbox </span><span class="uncovered1"><a
    name="line293"></a>293 bnds = self.bounds.split(&quot;,&quot;) </span><span
    class="uncovered0"><a name="line294"></a>294 cbounds = [] </span><span
    class="uncovered1"><a name="line295"></a>295 c_in, c_out, c_err =
    </span><span class="uncovered0"><a name="line296"></a>296
    Open3::popen3(&quot;echo #{bnds[0]} #{bnds[1]} | #{GDAL_PATH}cs2cs
    +proj=latlong +datum=WGS84 +to +proj=merc +ellps=sphere +a=6378137
    +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0&quot;) </span><span
    class="uncovered1"><a name="line297"></a>297 info = c_out.readlines.to_s
    </span><span class="uncovered0"><a name="line298"></a>298 string,cbounds[0],
    cbounds[1] = info.match(/([-.\d]+)\s*([-.\d]+).*/).to_a </span><span
    class="uncovered1"><a name="line299"></a>299 c_in, c_out, c_err =
    </span><span class="uncovered0"><a name="line300"></a>300
    Open3::popen3(&quot;echo #{bnds[2]} #{bnds[3]} | #{GDAL_PATH}cs2cs
    +proj=latlong +datum=WGS84 +to +proj=merc +ellps=sphere +a=6378137
    +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0&quot;) </span><span
    class="uncovered1"><a name="line301"></a>301 info = c_out.readlines.to_s
    </span><span class="uncovered0"><a name="line302"></a>302 string,cbounds[2],
    cbounds[3] = info.match(/([-.\d]+)\s*([-.\d]+).*/).to_a </span><span
    class="uncovered1"><a name="line303"></a>303 cbounds.join(&quot;,&quot;)
    </span><span class="uncovered0"><a name="line304"></a>304 end </span><span
    class="inferred1"><a name="line305"></a>305 </span><span
    class="inferred0"><a name="line306"></a>306 </span><span
    class="inferred1"><a name="line307"></a>307 #method to publish the map to
    cluster </span><span class="marked0"><a name="line308"></a>308 def publish
    </span><span class="inferred1"><a name="line309"></a>309 #self.status =
    :published </span><span class="inferred0"><a name="line310"></a>310 #save!
    </span><span class="inferred1"><a name="line311"></a>311 end </span><span
    class="inferred0"><a name="line312"></a>312 </span><span
    class="inferred1"><a name="line313"></a>313 #attempts to align based on the
    extent and offset of the </span><span class="inferred0"><a
    name="line314"></a>314 #reference map's warped image </span><span
    class="inferred1"><a name="line315"></a>315 #results it nicer gpcs to edit
    with later </span><span class="marked0"><a name="line316"></a>316 def
    align_with_warped (srcmap, align = nil, append = false) </span><span
    class="uncovered1"><a name="line317"></a>317 srcmap = Map.find(srcmap)
    </span><span class="uncovered0"><a name="line318"></a>318 origgcps =
    srcmap.gcps </span><span class="uncovered1"><a name="line319"></a>319
    </span><span class="uncovered0"><a name="line320"></a>320 #clear out
    original gcps, unless we want to append the copied gcps to the existing ones
    </span><span class="uncovered1"><a name="line321"></a>321
    self.gcps.destroy_all unless append == true </span><span
    class="uncovered0"><a name="line322"></a>322 </span><span
    class="uncovered1"><a name="line323"></a>323 #extent of source from gdalinfo
    </span><span class="uncovered0"><a name="line324"></a>324 stdin, stdout,
    sterr = Open3::popen3(&quot;#{GDAL_PATH}gdalinfo
    #{srcmap.warped_filename}&quot;) </span><span class="uncovered1"><a
    name="line325"></a>325 info = stdout.readlines.to_s </span><span
    class="uncovered0"><a name="line326"></a>326 string_lw,west,south =
    info.match(/Lower Left\s+\(\s*([-.\d]+), \s+([-.\d]+)/).to_a </span><span
    class="uncovered1"><a name="line327"></a>327 string_ur,east,north =
    info.match(/Upper Right\s+\(\s*([-.\d]+), \s+([-.\d]+)/).to_a </span><span
    class="uncovered0"><a name="line328"></a>328 </span><span
    class="uncovered1"><a name="line329"></a>329 lon_shift = west.to_f -
    east.to_f </span><span class="uncovered0"><a name="line330"></a>330
    lat_shift = south.to_f - north.to_f </span><span class="uncovered1"><a
    name="line331"></a>331 </span><span class="uncovered0"><a
    name="line332"></a>332 origgcps.each do |gcp| </span><span
    class="uncovered1"><a name="line333"></a>333 a = Gcp.new() </span><span
    class="uncovered0"><a name="line334"></a>334 a = gcp.clone </span><span
    class="uncovered1"><a name="line335"></a>335 if align == &quot;east&quot;
    </span><span class="uncovered0"><a name="line336"></a>336 a.lon -= lon_shift
    </span><span class="uncovered1"><a name="line337"></a>337 elsif align ==
    &quot;west&quot; </span><span class="uncovered0"><a name="line338"></a>338
    a.lon += lon_shift </span><span class="uncovered1"><a name="line339"></a>339
    elsif align == &quot;north&quot; </span><span class="uncovered0"><a
    name="line340"></a>340 a.lat -= lat_shift </span><span class="uncovered1"><a
    name="line341"></a>341 elsif align == &quot;south&quot; </span><span
    class="uncovered0"><a name="line342"></a>342 a.lat += lat_shift </span><span
    class="uncovered1"><a name="line343"></a>343 else </span><span
    class="uncovered0"><a name="line344"></a>344 #if no align, then dont change
    the gcps </span><span class="uncovered1"><a name="line345"></a>345 end
    </span><span class="uncovered0"><a name="line346"></a>346 a.map = self
    </span><span class="uncovered1"><a name="line347"></a>347 a.save
    </span><span class="uncovered0"><a name="line348"></a>348 end </span><span
    class="uncovered1"><a name="line349"></a>349 </span><span
    class="uncovered0"><a name="line350"></a>350 newgcps = self.gcps
    </span><span class="uncovered1"><a name="line351"></a>351 end </span><span
    class="inferred0"><a name="line352"></a>352 </span><span
    class="inferred1"><a name="line353"></a>353 #attempts to align based on the
    width and height of </span><span class="inferred0"><a name="line354"></a>354
    #reference map's un warped image </span><span class="inferred1"><a
    name="line355"></a>355 #results it potential better fit than
    align_with_warped </span><span class="inferred0"><a name="line356"></a>356
    #but with less accessible gpcs to edit </span><span class="marked1"><a
    name="line357"></a>357 def align_with_original(srcmap, align = nil, append =
    false) </span><span class="uncovered0"><a name="line358"></a>358 srcmap =
    Map.find(srcmap) </span><span class="uncovered1"><a name="line359"></a>359
    origgcps = srcmap.gcps </span><span class="uncovered0"><a
    name="line360"></a>360 </span><span class="uncovered1"><a
    name="line361"></a>361 #clear out original gcps, unless we want to append
    the copied gcps to the existing ones </span><span class="uncovered0"><a
    name="line362"></a>362 self.gcps.destroy_all unless append == true
    </span><span class="uncovered1"><a name="line363"></a>363 </span><span
    class="uncovered0"><a name="line364"></a>364 origgcps.each do |gcp|
    </span><span class="uncovered1"><a name="line365"></a>365 new_gcp =
    Gcp.new() </span><span class="uncovered0"><a name="line366"></a>366 new_gcp
    = gcp.clone </span><span class="uncovered1"><a name="line367"></a>367 if
    align == &quot;east&quot; </span><span class="uncovered0"><a
    name="line368"></a>368 new_gcp.x -= srcmap.width </span><span
    class="uncovered1"><a name="line369"></a>369 </span><span
    class="uncovered0"><a name="line370"></a>370 elsif align == &quot;west&quot;
    </span><span class="uncovered1"><a name="line371"></a>371 new_gcp.x +=
    srcmap.width </span><span class="uncovered0"><a name="line372"></a>372 elsif
    align == &quot;north&quot; </span><span class="uncovered1"><a
    name="line373"></a>373 new_gcp.y += srcmap.height </span><span
    class="uncovered0"><a name="line374"></a>374 elsif align ==
    &quot;south&quot; </span><span class="uncovered1"><a name="line375"></a>375
    new_gcp.y -= srcmap.height </span><span class="uncovered0"><a
    name="line376"></a>376 else </span><span class="uncovered1"><a
    name="line377"></a>377 #if no align, then dont change the gcps </span><span
    class="uncovered0"><a name="line378"></a>378 end </span><span
    class="uncovered1"><a name="line379"></a>379 new_gcp.map = self </span><span
    class="uncovered0"><a name="line380"></a>380 new_gcp.save </span><span
    class="uncovered1"><a name="line381"></a>381 end </span><span
    class="uncovered0"><a name="line382"></a>382 </span><span
    class="uncovered1"><a name="line383"></a>383 newgcps = self.gcps
    </span><span class="uncovered0"><a name="line384"></a>384 end </span><span
    class="inferred1"><a name="line385"></a>385 </span><span
    class="inferred0"><a name="line386"></a>386 # map gets error attibute set
    and gcps get error attribute set </span><span class="marked1"><a
    name="line387"></a>387 def gcps_with_error </span><span class="inferred0"><a
    name="line388"></a>388 gcps = Gcp.find(:all, :conditions =&gt;[&quot;map_id
    = ?&quot;, self.id], :order =&gt; 'created_at') </span><span
    class="uncovered1"><a name="line389"></a>389 gcps, map_error =
    ErrorCalculator::calc_error(gcps) </span><span class="uncovered0"><a
    name="line390"></a>390 @error = map_error </span><span class="uncovered1"><a
    name="line391"></a>391 #send back the gpcs with error calculation
    </span><span class="uncovered0"><a name="line392"></a>392 gcps </span><span
    class="uncovered1"><a name="line393"></a>393 end </span><span
    class="inferred0"><a name="line394"></a>394 </span><span
    class="inferred1"><a name="line395"></a>395 #Main warp method </span><span
    class="marked0"><a name="line396"></a>396 def warp!(resample_option,
    transform_option, use_mask=&quot;false&quot;) </span><span
    class="uncovered1"><a name="line397"></a>397 </span><span
    class="uncovered0"><a name="line398"></a>398 self.status = :warping
    </span><span class="uncovered1"><a name="line399"></a>399 save! </span><span
    class="uncovered0"><a name="line400"></a>400 </span><span
    class="uncovered1"><a name="line401"></a>401 gcp_array = self.gcps
    </span><span class="uncovered0"><a name="line402"></a>402 </span><span
    class="uncovered1"><a name="line403"></a>403 gcp_string = &quot;&quot;
    </span><span class="uncovered0"><a name="line404"></a>404 </span><span
    class="uncovered1"><a name="line405"></a>405 gcp_array.each do |gcp|
    </span><span class="uncovered0"><a name="line406"></a>406 gcp_string =
    gcp_string + gcp.gdal_string </span><span class="uncovered1"><a
    name="line407"></a>407 end </span><span class="uncovered0"><a
    name="line408"></a>408 </span><span class="uncovered1"><a
    name="line409"></a>409 mask_options = &quot;&quot; </span><span
    class="uncovered0"><a name="line410"></a>410 if use_mask == &quot;true&quot;
    &amp;&amp; self.mask_status == :masked </span><span class="uncovered1"><a
    name="line411"></a>411 src_filename = self.masked_src_filename </span><span
    class="uncovered0"><a name="line412"></a>412 mask_options = &quot;
    -srcnodata '17 17 17' &quot; </span><span class="uncovered1"><a
    name="line413"></a>413 else </span><span class="uncovered0"><a
    name="line414"></a>414 src_filename = self.unwarped_filename </span><span
    class="uncovered1"><a name="line415"></a>415 end </span><span
    class="uncovered0"><a name="line416"></a>416 </span><span
    class="uncovered1"><a name="line417"></a>417 dest_filename =
    self.warped_filename </span><span class="uncovered0"><a
    name="line418"></a>418 temp_filename = self.temp_filename </span><span
    class="uncovered1"><a name="line419"></a>419 </span><span
    class="uncovered0"><a name="line420"></a>420 #delete existing temp images
    @map.delete_images </span><span class="uncovered1"><a name="line421"></a>421
    if File.exists?(dest_filename) </span><span class="uncovered0"><a
    name="line422"></a>422 File.delete(dest_filename) </span><span
    class="uncovered1"><a name="line423"></a>423 end </span><span
    class="uncovered0"><a name="line424"></a>424 </span><span
    class="uncovered1"><a name="line425"></a>425 logger.info &quot;gdal
    translate&quot; </span><span class="uncovered0"><a name="line426"></a>426
    </span><span class="uncovered1"><a name="line427"></a>427 t_stdin, t_stdout,
    t_stderr = Open3::popen3( </span><span class="uncovered0"><a
    name="line428"></a>428 &quot;#{GDAL_PATH}gdal_translate -a_srs
    '+init=epsg:4326' -of VRT #{src_filename} #{temp_filename}.vrt
    #{gcp_string}&quot; </span><span class="uncovered1"><a
    name="line429"></a>429 ) </span><span class="uncovered0"><a
    name="line430"></a>430 </span><span class="uncovered1"><a
    name="line431"></a>431 logger.info &quot;gdal_translate -a_srs
    '+init=epsg:4326' -of VRT #{src_filename} #{temp_filename}.vrt
    #{gcp_string}&quot; </span><span class="uncovered0"><a
    name="line432"></a>432 t_out = t_stdout.readlines.to_s </span><span
    class="uncovered1"><a name="line433"></a>433 t_err = t_stderr.readlines.to_s
    </span><span class="uncovered0"><a name="line434"></a>434 </span><span
    class="uncovered1"><a name="line435"></a>435 if t_err.size &gt; 0
    </span><span class="uncovered0"><a name="line436"></a>436 logger.error
    &quot;ERROR gdal translate script: &quot;+ t_err </span><span
    class="uncovered1"><a name="line437"></a>437 logger.error &quot;Output =
    &quot; +t_out </span><span class="uncovered0"><a name="line438"></a>438
    t_out = &quot;ERROR with gdal translate script: &quot; + t_err +
    &quot;&lt;br /&gt; You may want to try it again? &lt;br /&gt;&quot; + t_out
    </span><span class="uncovered1"><a name="line439"></a>439 else </span><span
    class="uncovered0"><a name="line440"></a>440 t_out = &quot;Okay, translate
    command ran fine! &lt;div id = 'scriptout'&gt;&quot; + t_out +
    &quot;&lt;/div&gt;&quot; </span><span class="uncovered1"><a
    name="line441"></a>441 end </span><span class="uncovered0"><a
    name="line442"></a>442 </span><span class="uncovered1"><a
    name="line443"></a>443 trans_output = t_out </span><span
    class="uncovered0"><a name="line444"></a>444 </span><span
    class="uncovered1"><a name="line445"></a>445 memory_limit =
    (defined?(GDAL_MEMORY_LIMIT)) ? &quot;-wm &quot;+GDAL_MEMORY_LIMIT.to_s :
    &quot;&quot; </span><span class="uncovered0"><a name="line446"></a>446
    #check for -dstnodata 255 or -dstalpha ColorInterp=Palette </span><span
    class="uncovered1"><a name="line447"></a>447 #One of Gray, Palette, Red,
    Green, Blue, Alpha, Hue, Saturation, Lightness, Cyan, Magenta, Yellow,
    Black, or Unknown </span><span class="uncovered0"><a name="line448"></a>448
    i_stdin, i_stdout, i_stderr = Open3::popen3( </span><span
    class="uncovered1"><a name="line449"></a>449 &quot;#{GDAL_PATH}gdalinfo
    #{src_filename} -nomd -nogcp&quot; </span><span class="uncovered0"><a
    name="line450"></a>450 ) </span><span class="uncovered1"><a
    name="line451"></a>451 nodata_alpha = &quot;&quot; </span><span
    class="uncovered0"><a name="line452"></a>452 gdalinfo_stdout =
    i_stdout.readlines.to_s </span><span class="uncovered1"><a
    name="line453"></a>453 if
    !gdalinfo_stdout.match(&quot;Interp=Palet&quot;).nil? </span><span
    class="uncovered0"><a name="line454"></a>454 nodata_alpha = &quot;-dstnodata
    255&quot; </span><span class="uncovered1"><a name="line455"></a>455 elsif
    !gdalinfo_stdout.match(&quot;Interp=Undef&quot;).nil? </span><span
    class="uncovered0"><a name="line456"></a>456 nodata_alpha = &quot;-dstnodata
    255&quot; </span><span class="uncovered1"><a name="line457"></a>457 else
    </span><span class="uncovered0"><a name="line458"></a>458 nodata_alpha =
    &quot;-dstalpha &quot; </span><span class="uncovered1"><a
    name="line459"></a>459 end </span><span class="uncovered0"><a
    name="line460"></a>460 w_tdin, w_stdout, w_stderr = Open3::popen3(
    </span><span class="uncovered1"><a name="line461"></a>461
    &quot;#{GDAL_PATH}gdalwarp #{memory_limit} #{transform_option}
    #{resample_option} #{nodata_alpha} #{mask_options} -s_srs 'EPSG:4326'
    #{temp_filename}.vrt #{dest_filename} -co TILED=YES &quot; </span><span
    class="uncovered0"><a name="line462"></a>462 ) </span><span
    class="uncovered1"><a name="line463"></a>463 #emergency fix removed -co
    ALPHA=YES </span><span class="uncovered0"><a name="line464"></a>464
    logger.info &quot;gdalwarp #{memory_limit} #{transform_option}
    #{resample_option} #{nodata_alpha} #{mask_options} #{temp_filename}.vrt
    #{dest_filename} -co TILED=YES &quot; </span><span class="uncovered1"><a
    name="line465"></a>465 </span><span class="uncovered0"><a
    name="line466"></a>466 w_out = w_stdout.readlines.to_s </span><span
    class="uncovered1"><a name="line467"></a>467 w_err = w_stderr.readlines.to_s
    </span><span class="uncovered0"><a name="line468"></a>468 if w_err.size &gt;
    0 </span><span class="uncovered1"><a name="line469"></a>469 logger.error
    &quot;Error gdal warp script&quot; + w_err </span><span
    class="uncovered0"><a name="line470"></a>470 logger.error &quot;output =
    &quot;+w_out </span><span class="uncovered1"><a name="line471"></a>471 w_out
    = &quot;error with gdal warp: &quot;+ w_err +&quot;&lt;br /&gt; try it
    again?&lt;br /&gt;&quot;+ w_out </span><span class="uncovered0"><a
    name="line472"></a>472 else </span><span class="uncovered1"><a
    name="line473"></a>473 w_out = &quot;Okay, warp command ran fine! &lt;div
    id='scriptout'&gt;&quot; + w_out +&quot;&lt;/div&gt;&quot; </span><span
    class="uncovered0"><a name="line474"></a>474 end </span><span
    class="uncovered1"><a name="line475"></a>475 </span><span
    class="uncovered0"><a name="line476"></a>476 if File.exists?(temp_filename +
    '.vrt') </span><span class="uncovered1"><a name="line477"></a>477
    logger.info &quot;deleted temp vrt file&quot; </span><span
    class="uncovered0"><a name="line478"></a>478 File.delete(temp_filename +
    '.vrt') </span><span class="uncovered1"><a name="line479"></a>479 end
    </span><span class="uncovered0"><a name="line480"></a>480 </span><span
    class="uncovered1"><a name="line481"></a>481 warp_output = w_out
    </span><span class="uncovered0"><a name="line482"></a>482 </span><span
    class="uncovered1"><a name="line483"></a>483 if w_err.size &lt;= 0 and
    t_err.size &lt;= 0 </span><span class="uncovered0"><a name="line484"></a>484
    </span><span class="uncovered1"><a name="line485"></a>485 self.status =
    :warped </span><span class="uncovered0"><a name="line486"></a>486 save_bbox
    </span><span class="uncovered1"><a name="line487"></a>487
    convert_to_png(dest_filename) </span><span class="uncovered0"><a
    name="line488"></a>488 warp_successful = true </span><span
    class="uncovered1"><a name="line489"></a>489 </span><span
    class="uncovered0"><a name="line490"></a>490 else </span><span
    class="uncovered1"><a name="line491"></a>491 </span><span
    class="uncovered0"><a name="line492"></a>492 self.status = :available
    </span><span class="uncovered1"><a name="line493"></a>493 warp_successful =
    false </span><span class="uncovered0"><a name="line494"></a>494 </span><span
    class="uncovered1"><a name="line495"></a>495 end </span><span
    class="uncovered0"><a name="line496"></a>496 save! </span><span
    class="uncovered1"><a name="line497"></a>497 output = &quot;Step 1:
    Translate: &quot;+ trans_output + &quot;&lt;br /&gt;Step 2: Warp: &quot; +
    warp_output </span><span class="uncovered0"><a name="line498"></a>498
    warp_successful </span><span class="uncovered1"><a name="line499"></a>499
    end </span><span class="inferred0"><a name="line500"></a>500 </span><span
    class="marked1"><a name="line501"></a>501 def mask! </span><span
    class="uncovered0"><a name="line502"></a>502 </span><span
    class="uncovered1"><a name="line503"></a>503 self.mask_status = :masking
    </span><span class="uncovered0"><a name="line504"></a>504 save! </span><span
    class="uncovered1"><a name="line505"></a>505 format = self.mask_file_format
    </span><span class="uncovered0"><a name="line506"></a>506 </span><span
    class="uncovered1"><a name="line507"></a>507 if format == &quot;gml&quot;
    </span><span class="uncovered0"><a name="line508"></a>508 return &quot;no
    masking file found, have you created a clipping mask and saved it?&quot;
    unless File.exists?(masking_file_gml) </span><span class="uncovered1"><a
    name="line509"></a>509 masking_file = self.masking_file_gml </span><span
    class="uncovered0"><a name="line510"></a>510 layer = &quot;features&quot;
    </span><span class="uncovered1"><a name="line511"></a>511 </span><span
    class="uncovered0"><a name="line512"></a>512 else </span><span
    class="uncovered1"><a name="line513"></a>513 return &quot;no masking file
    matching specified format found.&quot; </span><span class="uncovered0"><a
    name="line514"></a>514 end </span><span class="uncovered1"><a
    name="line515"></a>515 </span><span class="uncovered0"><a
    name="line516"></a>516 masked_src_filename = self.masked_src_filename
    </span><span class="uncovered1"><a name="line517"></a>517
    File.delete(masked_src_filename) if File.exists?(masked_src_filename)
    </span><span class="uncovered0"><a name="line518"></a>518 #copy over orig to
    a new unmasked file </span><span class="uncovered1"><a
    name="line519"></a>519 File.copy(unwarped_filename, masked_src_filename)
    </span><span class="uncovered0"><a name="line520"></a>520 </span><span
    class="uncovered1"><a name="line521"></a>521 </span><span
    class="uncovered0"><a name="line522"></a>522 r_stdin, r_stdout, r_stderr =
    Open3::popen3( </span><span class="uncovered1"><a name="line523"></a>523
    &quot;#{GDAL_PATH}gdal_rasterize -i -burn 17 -b 1 -b 2 -b 3 #{masking_file}
    -l #{layer} #{masked_src_filename}&quot; </span><span class="uncovered0"><a
    name="line524"></a>524 ) </span><span class="uncovered1"><a
    name="line525"></a>525 logger.info &quot;gdal_rasterize -i -burn 17 -b 1 -b
    2 -b 3 #{masking_file} -l #{layer} #{masked_src_filename}&quot; </span><span
    class="uncovered0"><a name="line526"></a>526 r_out = r_stdout.readlines.to_s
    </span><span class="uncovered1"><a name="line527"></a>527 r_err =
    r_stderr.readlines.to_s </span><span class="uncovered0"><a
    name="line528"></a>528 if r_err.size &gt; 0 </span><span
    class="uncovered1"><a name="line529"></a>529 #error, need to fail nicely
    </span><span class="uncovered0"><a name="line530"></a>530 logger.error
    &quot;ERROR gdal rasterize script: &quot;+ r_err </span><span
    class="uncovered1"><a name="line531"></a>531 logger.error &quot;Output =
    &quot; +r_out </span><span class="uncovered0"><a name="line532"></a>532
    r_out = &quot;ERROR with gdal rasterise script: &quot; + r_err +
    &quot;&lt;br /&gt; You may want to try it again? &lt;br /&gt;&quot; + r_out
    </span><span class="uncovered1"><a name="line533"></a>533 else </span><span
    class="uncovered0"><a name="line534"></a>534 # r_out = &quot;Okay, rasterise
    command ran fine! &lt;div id = 'scriptout'&gt;&quot; + r_out +
    &quot;&lt;/div&gt;&quot; </span><span class="uncovered1"><a
    name="line535"></a>535 </span><span class="uncovered0"><a
    name="line536"></a>536 r_out = &quot;Success! Map was cropped!&quot;
    </span><span class="uncovered1"><a name="line537"></a>537 end </span><span
    class="uncovered0"><a name="line538"></a>538 </span><span
    class="uncovered1"><a name="line539"></a>539 self.mask_status = :masked
    </span><span class="uncovered0"><a name="line540"></a>540 save! </span><span
    class="uncovered1"><a name="line541"></a>541 r_out </span><span
    class="uncovered0"><a name="line542"></a>542 end </span><span
    class="inferred1"><a name="line543"></a>543 </span><span
    class="inferred0"><a name="line544"></a>544 </span><span
    class="inferred1"><a name="line545"></a>545 # gdal_rasterize -burn 17 -b 1
    -b 2 -b 3 SSS.gml -l features orig.tif </span><span class="inferred0"><a
    name="line546"></a>546 </span><span class="marked1"><a
    name="line547"></a>547 def delete_mask </span><span class="uncovered0"><a
    name="line548"></a>548 logger.info &quot;delete mask&quot; </span><span
    class="uncovered1"><a name="line549"></a>549 if
    File.exists?(self.masking_file_gml) </span><span class="uncovered0"><a
    name="line550"></a>550 File.delete(self.masking_file_gml) </span><span
    class="uncovered1"><a name="line551"></a>551 end </span><span
    class="uncovered0"><a name="line552"></a>552 if
    File.exists?(self.masking_file_gml+&quot;.ol&quot;) </span><span
    class="uncovered1"><a name="line553"></a>553
    File.delete(self.masking_file_gml+&quot;.ol&quot;) </span><span
    class="uncovered0"><a name="line554"></a>554 end </span><span
    class="uncovered1"><a name="line555"></a>555 if
    File.exists?(self.masking_file_gfs) </span><span class="uncovered0"><a
    name="line556"></a>556 File.delete(self.masking_file_gfs) </span><span
    class="uncovered1"><a name="line557"></a>557 end </span><span
    class="uncovered0"><a name="line558"></a>558 </span><span
    class="uncovered1"><a name="line559"></a>559 self.mask_status = :unmasked
    </span><span class="uncovered0"><a name="line560"></a>560 save! </span><span
    class="uncovered1"><a name="line561"></a>561 &quot;mask deleted&quot;
    </span><span class="uncovered0"><a name="line562"></a>562 end </span><span
    class="inferred1"><a name="line563"></a>563 </span><span
    class="inferred0"><a name="line564"></a>564 </span><span class="marked1"><a
    name="line565"></a>565 def save_mask(vector_features) </span><span
    class="uncovered0"><a name="line566"></a>566 if self.mask_file_format ==
    &quot;gml&quot; </span><span class="uncovered1"><a name="line567"></a>567
    msg = save_mask_gml(vector_features) </span><span class="uncovered0"><a
    name="line568"></a>568 </span><span class="uncovered1"><a
    name="line569"></a>569 else </span><span class="uncovered0"><a
    name="line570"></a>570 msg = &quot;Mask format unknown&quot; </span><span
    class="uncovered1"><a name="line571"></a>571 end </span><span
    class="uncovered0"><a name="line572"></a>572 msg </span><span
    class="uncovered1"><a name="line573"></a>573 end </span><span
    class="inferred0"><a name="line574"></a>574 </span><span
    class="inferred1"><a name="line575"></a>575 </span><span
    class="inferred0"><a name="line576"></a>576 #parses geometry from
    openlayers, and saves it to file. </span><span class="inferred1"><a
    name="line577"></a>577 #GML format </span><span class="marked0"><a
    name="line578"></a>578 def save_mask_gml(features) </span><span
    class="uncovered1"><a name="line579"></a>579 if
    File.exists?(self.masking_file_gml) </span><span class="uncovered0"><a
    name="line580"></a>580 File.delete(self.masking_file_gml) </span><span
    class="uncovered1"><a name="line581"></a>581 end </span><span
    class="uncovered0"><a name="line582"></a>582 if
    File.exists?(self.masking_file_gml+&quot;.ol&quot;) </span><span
    class="uncovered1"><a name="line583"></a>583
    File.delete(self.masking_file_gml+&quot;.ol&quot;) </span><span
    class="uncovered0"><a name="line584"></a>584 end </span><span
    class="uncovered1"><a name="line585"></a>585 if
    File.exists?(self.masking_file_gfs) </span><span class="uncovered0"><a
    name="line586"></a>586 File.delete(self.masking_file_gfs) </span><span
    class="uncovered1"><a name="line587"></a>587 end </span><span
    class="uncovered0"><a name="line588"></a>588 origfile =
    File.new(self.masking_file_gml+&quot;.ol&quot;, &quot;w+&quot;) </span><span
    class="uncovered1"><a name="line589"></a>589 origfile.puts(features)
    </span><span class="uncovered0"><a name="line590"></a>590 origfile.close
    </span><span class="uncovered1"><a name="line591"></a>591 </span><span
    class="uncovered0"><a name="line592"></a>592 doc = REXML::Document.new
    features </span><span class="uncovered1"><a name="line593"></a>593
    REXML::XPath.each( doc, &quot;//gml:coordinates&quot;) { | element|
    </span><span class="uncovered0"><a name="line594"></a>594 # blimey
    element.text.split(' ').map {|i| i.split(',')}.map{ |i| i[0] =&gt;
    i[1]}.inject({}){|i,j| i.merge(j)} </span><span class="uncovered1"><a
    name="line595"></a>595 coords_array = element.text.split(' ') </span><span
    class="uncovered0"><a name="line596"></a>596 new_coords_array = Array.new
    </span><span class="uncovered1"><a name="line597"></a>597 coords_array.each
    do |coordpair| </span><span class="uncovered0"><a name="line598"></a>598
    coord = coordpair.split(',') </span><span class="uncovered1"><a
    name="line599"></a>599 coord[1] = self.height - coord[1].to_f </span><span
    class="uncovered0"><a name="line600"></a>600 newcoord = coord.join(',')
    </span><span class="uncovered1"><a name="line601"></a>601 new_coords_array
    &lt;&lt; newcoord </span><span class="uncovered0"><a name="line602"></a>602
    end </span><span class="uncovered1"><a name="line603"></a>603 element.text =
    new_coords_array.join(' ') </span><span class="uncovered0"><a
    name="line604"></a>604 </span><span class="uncovered1"><a
    name="line605"></a>605 } #element </span><span class="uncovered0"><a
    name="line606"></a>606 gmlfile = File.new(self.masking_file_gml,
    &quot;w+&quot;) </span><span class="uncovered1"><a name="line607"></a>607
    doc.write(gmlfile) </span><span class="uncovered0"><a name="line608"></a>608
    gmlfile.close </span><span class="uncovered1"><a name="line609"></a>609
    message = &quot;Map clipping mask saved (gml)&quot; </span><span
    class="uncovered0"><a name="line610"></a>610 end </span><span
    class="inferred1"><a name="line611"></a>611 </span><span class="marked0"><a
    name="line612"></a>612 def self.paged_find_tagged_with(tags, args = {})
    </span><span class="uncovered1"><a name="line613"></a>613 if tags.blank?
    </span><span class="uncovered0"><a name="line614"></a>614 paginate args
    </span><span class="uncovered1"><a name="line615"></a>615 else </span><span
    class="uncovered0"><a name="line616"></a>616 options =
    find_options_for_find_tagged_with(tags, :match_all =&gt; true) </span><span
    class="uncovered1"><a name="line617"></a>617 options.merge!(args)
    </span><span class="uncovered0"><a name="line618"></a>618 # The default
    count query generated by paginate includes COUNT(DISTINCT Posts.*) which
    errors, at least on mysql </span><span class="uncovered1"><a
    name="line619"></a>619 # Below we override the default select statement used
    to perform the count so that it becomes COUNT(DISTINCT Posts.id)
    </span><span class="uncovered0"><a name="line620"></a>620
    paginate(options.merge(:count =&gt; { :select =&gt;
    options[:select].gsub('*', 'id') })) </span><span class="uncovered1"><a
    name="line621"></a>621 end </span><span class="uncovered0"><a
    name="line622"></a>622 end </span><span class="inferred1"><a
    name="line623"></a>623 #can put more things under here? </span><span
    class="inferred0"><a name="line624"></a>624 </span><span
    class="inferred1"><a name="line625"></a>625 ############ </span><span
    class="inferred0"><a name="line626"></a>626 #PRIVATE </span><span
    class="inferred1"><a name="line627"></a>627 ############ </span><span
    class="inferred0"><a name="line628"></a>628 #saves the map to its own
    mapfile for use with wms mapserver </span><span class="marked1"><a
    name="line629"></a>629 def save_mapfile </span><span class="uncovered0"><a
    name="line630"></a>630 map_title = ERB::Util.html_escape title </span><span
    class="uncovered1"><a name="line631"></a>631 </span><span
    class="uncovered0"><a name="line632"></a>632 map_title.gsub!(/\W+/, ' ')
    </span><span class="uncovered1"><a name="line633"></a>633 map_filename =
    ERB::Util.html_escape self.warped_filename </span><span
    class="uncovered0"><a name="line634"></a>634 map_layer_name = id
    </span><span class="uncovered1"><a name="line635"></a>635 </span><span
    class="uncovered0"><a name="line636"></a>636 map_original_layer_name =
    id.to_s + &quot;_original&quot; </span><span class="uncovered1"><a
    name="line637"></a>637 map_original_filename = ERB::Util.html_escape
    self.unwarped_filename # self.upload.path </span><span class="uncovered0"><a
    name="line638"></a>638 </span><span class="uncovered1"><a
    name="line639"></a>639 ourmapfile = File.open(self.mapfile,
    File::CREAT|File::TRUNC|File::RDWR, 0666) </span><span class="uncovered0"><a
    name="line640"></a>640 template =
    File.open(RAILS_ROOT+&quot;/db/maptemplates/mapfile.text.erb&quot;).read
    </span><span class="uncovered1"><a name="line641"></a>641 </span><span
    class="uncovered0"><a name="line642"></a>642 ourmapfile.puts
    ERB.new(template).result( binding ) </span><span class="uncovered1"><a
    name="line643"></a>643 ourmapfile.close </span><span class="uncovered0"><a
    name="line644"></a>644 end </span><span class="inferred1"><a
    name="line645"></a>645 </span><span class="marked0"><a
    name="line646"></a>646 def convert_to_png(filename) </span><span
    class="uncovered1"><a name="line647"></a>647 logger.info &quot;convert to
    png&quot; </span><span class="uncovered0"><a name="line648"></a>648
    warped_png = filename + &quot;.png&quot; </span><span class="uncovered1"><a
    name="line649"></a>649 stdin, stdout, stderr =
    Open3::popen3(&quot;#{GDAL_PATH}gdal_translate -of png #{filename}
    #{warped_png}&quot;) </span><span class="uncovered0"><a
    name="line650"></a>650 #logger.info stdout.readlines.to_s </span><span
    class="uncovered1"><a name="line651"></a>651 logger.info &quot;#{filename}
    -&gt; #{warped_png}&quot; </span><span class="uncovered0"><a
    name="line652"></a>652 end </span><span class="uncovered1"><a
    name="line653"></a>653 </span><span class="uncovered0"><a
    name="line654"></a>654 </span><span class="uncovered1"><a
    name="line655"></a>655 end </span></pre>
    <hr />
    <p> Generated using the <a href='http://eigenclass.org/hiki.rb?rcov'> rcov
    code coverage analysis tool for Ruby </a> version 0.8.1.2. </p>
    <p>
      <a href='http://validator.w3.org/check/referer'>
        <img src='http://www.w3.org/Icons/valid-xhtml10' height='31' alt='Valid XHTML 1.0!' width='88' />
      </a>
      <a href='http://jigsaw.w3.org/css-validator/check/referer'>
        <img src='http://jigsaw.w3.org/css-validator/images/vcss' alt='Valid CSS!' style='border:0;width:88px;height:31px' />
      </a>
    </p>
  </body>
</html>
