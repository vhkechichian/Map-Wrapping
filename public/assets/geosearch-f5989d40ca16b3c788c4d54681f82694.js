function searchmapinit(){jQuery("#loadingDiv").hide(),OpenLayers.IMAGE_RELOAD_ATTEMPTS=3,OpenLayers.Util.onImageLoadErrorColor="transparent";var e={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",numZoomLevels:20,maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),controls:[new OpenLayers.Control.Attribution,new OpenLayers.Control.LayerSwitcher,new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar]};searchmap=new OpenLayers.Map("searchmap",e),mapnik_s=mapnik.clone(),searchmap.addLayer(mapnik_s);var a=(OpenLayers.Util.extend({strokeWidth:3},OpenLayers.Feature.Vector.style["default"]),OpenLayers.Util.extend({fillColor:"#ee9900",fillOpacity:.4},OpenLayers.Feature.Vector.style.select),{fill:!1,fillOpacity:0}),r={fill:!0,strokeOpacity:1,strokeColor:"#blue",fillColor:"blue",fillOpacity:.4,strokeWidth:2},t=new OpenLayers.StyleMap({"default":a,select:r});mapIndexLayer=new OpenLayers.Layer.Vector("Map Outlines",{styleMap:t,visibility:!1}),mapIndexSelCtrl=new OpenLayers.Control.SelectFeatureNoClick(mapIndexLayer,{hover:!1,onSelect:onFeatureSelect,onUnselect:onFeatureUnselect}),searchmap.addControl(mapIndexSelCtrl),mapIndexSelCtrl.deactivate(),searchmap.addLayer(mapIndexLayer),searchmap.events.register("moveend",this,updateSearch),clipmap_bounds_merc=new OpenLayers.Bounds,clipmap_bounds_merc=gs_bounds.transform(searchmap.displayProjection,searchmap.projection),searchmap.zoomToExtent(clipmap_bounds_merc,!0),addClickToTable(),do_search()}function updateSearch(){var e=(new Date).valueOf();currentState={tag:e},firstGo?firstGo=!1:setTimeout(function(){updateStuff(e)},2e3)}function updateStuff(e){currentState.tag==e&&do_search()}function addClickToTable(){jQuery("#searchmap-table tr").click(function(){removeAllPopups(searchmap),mapIndexSelCtrl.unselectAll();for(var e,a=this.id.substring("map-row-".length),r=0;r<mapIndexLayer.features.length;r++)mapIndexLayer.features[r].mapId==a&&(e=mapIndexLayer.features[r]);mapIndexSelCtrl.select(e)})}function doPlaceSearch(e){var a=e.place.value,r={place:a,format:"json"};OpenLayers.loadURL(mapBaseURL+"/geosearch",r,this,doPlaceZoom,failMessage)}function doPlaceZoom(e){var a=new OpenLayers.Format.JSON;extent=a.read(e.responseText);var r=new OpenLayers.Bounds(extent[0],extent[1],extent[2],extent[3]),t=r.transform(searchmap.displayProjection,searchmap.projection);searchmap.zoomToExtent(t)}function do_search(e){jQuery("#loadingDiv").show(),"undefined"==typeof e&&(e=1);var a=searchmap.getExtent().transform(searchmap.projection,searchmap.displayProjection).toArray(),r={bbox:a,format:"json",page:e,operation:"intersect"};OpenLayers.loadURL(mapBaseURL+"/geosearch",r,this,loadItems,failMessage)}function clearMapTable(){jQuery("#searchmap-table").empty()}function loadItems(e){clearMapTable(),removeAllPopups(searchmap),mapIndexLayer.destroyFeatures();var a=new OpenLayers.Format.JSON;jj=a.read(e.responseText),smaps=jj.items;for(var r=0;r<smaps.length;r++){var t=smaps[r];addMapToMapLayer(t)}insertMapTablePagination(jj.total_entries,jj.per_page,jj.current_page),replaceMapTable(smaps),mapIndexLayer.setVisibility(!0),jQuery("#loadingDiv").hide()}function failMessage(){alert("Sorry, something went wrong with the search"),jQuery("#loadingDiv").hide()}function onPopupClose(){mapIndexSelCtrl.unselect(selectedFeature)}function onFeatureUnselect(e){jQuery("tr#map-row-"+e.mapId).removeClass("highlight"),searchmap.removePopup(e.popup),e.popup.destroy(),e.popup=null}function removeAllPopups(e){for(var a=0;a<e.popups.length;a++)e.removePopup(e.popups[a])}var searchmap,maxOpacity=1,minOpacity=.1,mapIndexLayer,mapIndexSelCtrl,selectedFeature,firstGo=!0,currentState;